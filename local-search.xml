<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>infinity</title>
    <link href="/2025/01/07/infinity/"/>
    <url>/2025/01/07/infinity/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>var</title>
    <link href="/2025/01/07/var/"/>
    <url>/2025/01/07/var/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Residual-Quantization</title>
    <link href="/2025/01/06/Residual-Quantization/"/>
    <url>/2025/01/06/Residual-Quantization/</url>
    
    <content type="html"><![CDATA[<h2 id="1-ä»€ä¹ˆæ˜¯-residual-quantization"><a class="markdownIt-Anchor" href="#1-ä»€ä¹ˆæ˜¯-residual-quantization"></a> 1. ä»€ä¹ˆæ˜¯ Residual Quantizationï¼Ÿ</h2><p><strong>Residual Quantization (RQ)</strong> æ˜¯ä¸€ç§å‘é‡é‡åŒ–æ–¹æ³•ï¼Œé€šè¿‡å¤šé˜¶æ®µé€æ­¥é‡åŒ–å‘é‡çš„æ®‹å·®æ¥å®ç°é«˜ç²¾åº¦çš„å‘é‡è¡¨ç¤ºã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†ä¸€ä¸ªé«˜ç»´å‘é‡åˆ†è§£ä¸ºå¤šä¸ªè¾ƒä½ç²¾åº¦çš„å‘é‡çš„å’Œï¼Œæ¯ä¸ªé˜¶æ®µè´Ÿè´£é‡åŒ–å‰ä¸€é˜¶æ®µæœªèƒ½æ•æ‰åˆ°çš„æ®‹å·®éƒ¨åˆ†ã€‚è¿™ç§æ–¹æ³•èƒ½å¤Ÿæ˜¾è‘—é™ä½é‡åŒ–è¯¯å·®ï¼Œæé«˜è¡¨ç¤ºçš„å‡†ç¡®æ€§ã€‚</p><h3 id="ä¸»è¦ç‰¹ç‚¹"><a class="markdownIt-Anchor" href="#ä¸»è¦ç‰¹ç‚¹"></a> ä¸»è¦ç‰¹ç‚¹</h3><ul><li><strong>å¤šé˜¶æ®µé‡åŒ–</strong>ï¼šé€šè¿‡å¤šä¸ªé‡åŒ–æ­¥éª¤é€æ­¥é€¼è¿‘åŸå§‹å‘é‡ã€‚</li><li><strong>æ®‹å·®æ•æ‰</strong>ï¼šæ¯ä¸ªé‡åŒ–é˜¶æ®µä¸“æ³¨äºæ•æ‰å‰ä¸€é˜¶æ®µçš„æ®‹å·®ï¼Œæé«˜æ•´ä½“é‡åŒ–ç²¾åº¦ã€‚</li><li><strong>çµæ´»æ€§</strong>ï¼šå¯ä»¥æ ¹æ®éœ€æ±‚è°ƒæ•´é‡åŒ–é˜¶æ®µçš„æ•°é‡å’Œæ¯é˜¶æ®µçš„åµŒå…¥æ•°é‡ã€‚</li></ul><h2 id="2-residual-quantization-çš„å·¥ä½œåŸç†"><a class="markdownIt-Anchor" href="#2-residual-quantization-çš„å·¥ä½œåŸç†"></a> 2. Residual Quantization çš„å·¥ä½œåŸç†</h2><p>Residual Quantization çš„æ ¸å¿ƒæ˜¯é€šè¿‡å¤šä¸ªé‡åŒ–é˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µé‡åŒ–å‰ä¸€é˜¶æ®µçš„æ®‹å·®ï¼Œé€æ­¥é€¼è¿‘åŸå§‹å‘é‡ã€‚å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p><strong>åˆå§‹åŒ–</strong>ï¼š</p><ul><li>è®¾å®šé‡åŒ–é˜¶æ®µæ•° ( K ) å’Œæ¯é˜¶æ®µçš„åµŒå…¥æ•°é‡ ( M )ã€‚</li><li>åˆå§‹åŒ– ( K ) ä¸ªä»£ç ä¹¦ï¼ˆCodebookï¼‰ï¼Œæ¯ä¸ªä»£ç ä¹¦åŒ…å« ( M ) ä¸ªåµŒå…¥å‘é‡ã€‚</li></ul></li><li><p><strong>é‡åŒ–è¿‡ç¨‹</strong>ï¼š</p><ul><li><p><strong>é˜¶æ®µ 1</strong>ï¼š</p><ul><li>å°†åŸå§‹å‘é‡ ( x ) ä¸é˜¶æ®µ 1 çš„ä»£ç ä¹¦ä¸­çš„åµŒå…¥å‘é‡ ( e_1 ) è¿›è¡ŒåŒ¹é…ï¼Œæ‰¾åˆ°æœ€æ¥è¿‘çš„åµŒå…¥å‘é‡ ( e_{1k} )ã€‚</li><li>è®°å½•åŒ¹é…çš„ç´¢å¼• ( k_1 )ã€‚</li><li>è®¡ç®—æ®‹å·® ( r_1 = x - e_{1k_1} )ã€‚</li></ul></li><li><p><strong>é˜¶æ®µ 2</strong>ï¼š</p><ul><li>ä½¿ç”¨æ®‹å·® ( r_1 ) ä¸é˜¶æ®µ 2 çš„ä»£ç ä¹¦ä¸­çš„åµŒå…¥å‘é‡ ( e_2 ) è¿›è¡ŒåŒ¹é…ï¼Œæ‰¾åˆ°æœ€æ¥è¿‘çš„åµŒå…¥å‘é‡ ( e_{2k_2} )ã€‚</li><li>è®°å½•åŒ¹é…çš„ç´¢å¼• ( k_2 )ã€‚</li><li>è®¡ç®—æ–°çš„æ®‹å·® ( r_2 = r_1 - e_{2k_2} )ã€‚</li></ul></li><li><p><strong>ä»¥æ­¤ç±»æ¨</strong>ï¼Œç›´åˆ°æ‰€æœ‰ ( K ) ä¸ªé˜¶æ®µå®Œæˆã€‚</p></li></ul></li><li><p><strong>é‡æ„è¿‡ç¨‹</strong>ï¼š</p><ul><li>å°†æ‰€æœ‰é˜¶æ®µçš„åµŒå…¥å‘é‡ç›¸åŠ ï¼Œå¾—åˆ°é‡æ„å‘é‡ï¼š<br>[<br>\hat{x} = e_{1k_1} + e_{2k_2} + \dots + e_{Kk_K}<br>]</li></ul></li><li><p><strong>æŸå¤±ä¸ä¼˜åŒ–</strong>ï¼š</p><ul><li>ä½¿ç”¨é€‚å½“çš„æŸå¤±å‡½æ•°ï¼ˆå¦‚å‡æ–¹è¯¯å·®ï¼ŒMSEï¼‰æœ€å°åŒ–é‡æ„å‘é‡ä¸åŸå§‹å‘é‡ä¹‹é—´çš„å·®å¼‚ã€‚</li><li>æ›´æ–°å„é˜¶æ®µçš„ä»£ç ä¹¦ä»¥ä¼˜åŒ–é‡åŒ–æ€§èƒ½ã€‚</li></ul></li></ol><h3 id="å›¾ç¤º"><a class="markdownIt-Anchor" href="#å›¾ç¤º"></a> å›¾ç¤º</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs 1c">åŸå§‹å‘é‡ x<br>   <span class="hljs-string">|</span><br>   <span class="hljs-string">|---&gt; é˜¶æ®µ1: æ‰¾åˆ° e1k1, è®¡ç®— r1 = x - e1k1</span><br>   <span class="hljs-string">|</span><br>   <span class="hljs-string">|---&gt; é˜¶æ®µ2: æ‰¾åˆ° e2k2, è®¡ç®— r2 = r1 - e2k2</span><br>   <span class="hljs-string">|</span><br>   <span class="hljs-string">|---&gt; ...</span><br>   <span class="hljs-string">|</span><br>   <span class="hljs-string">|---&gt; é˜¶æ®µK: æ‰¾åˆ° eKkK, è®¡ç®— rK = rK-1 - eKkK</span><br>   <span class="hljs-string">|</span><br>é‡æ„å‘é‡<span class="hljs-punctuation">:</span> e1k1 <span class="hljs-punctuation">+</span> e2k2 <span class="hljs-punctuation">+</span> ... <span class="hljs-punctuation">+</span> eKkK<br></code></pre></td></tr></table></figure><h2 id="3-residual-quantization-çš„ä¼˜ç¼ºç‚¹"><a class="markdownIt-Anchor" href="#3-residual-quantization-çš„ä¼˜ç¼ºç‚¹"></a> 3. Residual Quantization çš„ä¼˜ç¼ºç‚¹</h2><h3 id="ä¼˜ç‚¹"><a class="markdownIt-Anchor" href="#ä¼˜ç‚¹"></a> ä¼˜ç‚¹</h3><ol><li><p><strong>æé«˜é‡åŒ–ç²¾åº¦</strong>ï¼š</p><ul><li>é€šè¿‡å¤šé˜¶æ®µé‡åŒ–ï¼Œé€æ­¥é€¼è¿‘åŸå§‹å‘é‡ï¼Œæ˜¾è‘—é™ä½é‡åŒ–è¯¯å·®ã€‚</li></ul></li><li><p><strong>çµæ´»æ€§</strong>ï¼š</p><ul><li>å¯ä»¥æ ¹æ®éœ€æ±‚è°ƒæ•´é‡åŒ–é˜¶æ®µæ•° ( K ) å’Œæ¯é˜¶æ®µçš„åµŒå…¥æ•°é‡ ( M )ï¼Œä»¥æƒè¡¡ç²¾åº¦å’Œè®¡ç®—æˆæœ¬ã€‚</li></ul></li><li><p><strong>é«˜æ•ˆè¡¨ç¤º</strong>ï¼š</p><ul><li>å¯¹äºé«˜ç»´æ•°æ®ï¼ŒRQ èƒ½å¤Ÿæä¾›ç´§å‡‘è€Œå‡†ç¡®çš„è¡¨ç¤ºï¼Œé€‚ç”¨äºå‹ç¼©å’Œé«˜æ•ˆå­˜å‚¨ã€‚</li></ul></li></ol><h3 id="ç¼ºç‚¹"><a class="markdownIt-Anchor" href="#ç¼ºç‚¹"></a> ç¼ºç‚¹</h3><ol><li><p><strong>è®¡ç®—å¤æ‚åº¦é«˜</strong>ï¼š</p><ul><li>å¤šé˜¶æ®µé‡åŒ–å¢åŠ äº†è®¡ç®—å¼€é”€ï¼Œå°¤å…¶åœ¨é«˜é˜¶æ®µæ•° ( K ) æ—¶ï¼ŒåŒ¹é…è¿‡ç¨‹å¯èƒ½å˜å¾—æ˜‚è´µã€‚</li></ul></li><li><p><strong>ä»£ç ä¹¦ç®¡ç†</strong>ï¼š</p><ul><li>æ¯ä¸ªé‡åŒ–é˜¶æ®µéœ€è¦ç»´æŠ¤ç‹¬ç«‹çš„ä»£ç ä¹¦ï¼Œå¢åŠ äº†å†…å­˜å’Œç®¡ç†çš„å¤æ‚æ€§ã€‚</li></ul></li><li><p><strong>è®­ç»ƒå¤æ‚æ€§</strong>ï¼š</p><ul><li>åœ¨æ·±åº¦å­¦ä¹ æ¨¡å‹ä¸­é›†æˆ RQ éœ€è¦å¤„ç†æ¢¯åº¦ä¼ æ’­å’Œä»£ç ä¹¦æ›´æ–°ç­‰é—®é¢˜ï¼Œå¢åŠ äº†å®ç°éš¾åº¦ã€‚</li></ul></li></ol><h2 id="4-residual-quantization-ä¸ä¼ ç»Ÿé‡åŒ–æ–¹æ³•çš„æ¯”è¾ƒ"><a class="markdownIt-Anchor" href="#4-residual-quantization-ä¸ä¼ ç»Ÿé‡åŒ–æ–¹æ³•çš„æ¯”è¾ƒ"></a> 4. Residual Quantization ä¸ä¼ ç»Ÿé‡åŒ–æ–¹æ³•çš„æ¯”è¾ƒ</h2><table><thead><tr><th>ç‰¹æ€§</th><th>ä¼ ç»Ÿå‘é‡é‡åŒ–ï¼ˆVQï¼‰</th><th>æ®‹å·®é‡åŒ–ï¼ˆRQï¼‰</th></tr></thead><tbody><tr><td><strong>é‡åŒ–é˜¶æ®µ</strong></td><td>å•é˜¶æ®µ</td><td>å¤šé˜¶æ®µ</td></tr><tr><td><strong>é‡åŒ–ç²¾åº¦</strong></td><td>è¾ƒä½</td><td>è¾ƒé«˜</td></tr><tr><td><strong>è®¡ç®—å¤æ‚åº¦</strong></td><td>è¾ƒä½</td><td>è¾ƒé«˜</td></tr><tr><td><strong>ä»£ç ä¹¦æ•°é‡</strong></td><td>ä¸€ä¸ª</td><td>å¤šä¸ª</td></tr><tr><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>ç®€å•å‹ç¼©ã€å°è§„æ¨¡æ¨¡å‹</td><td>é«˜ç²¾åº¦å‹ç¼©ã€å¤§è§„æ¨¡æ¨¡å‹</td></tr><tr><td><strong>è¡¨ç¤ºèƒ½åŠ›</strong></td><td>æœ‰é™</td><td>æ›´å¼ºï¼Œé€æ­¥é€¼è¿‘æ›´å¤æ‚çš„æ•°æ®ç»“æ„</td></tr><tr><td><strong>å®ç°å¤æ‚æ€§</strong></td><td>ç®€å•</td><td>å¤æ‚ï¼Œéœ€è¦ç®¡ç†å¤šä¸ªä»£ç ä¹¦å’Œæ®‹å·®è¿‡ç¨‹</td></tr></tbody></table><p><strong>æ€»ç»“</strong>ï¼šResidual Quantization åœ¨é‡åŒ–ç²¾åº¦å’Œè¡¨ç¤ºèƒ½åŠ›ä¸Šæ˜æ˜¾ä¼˜äºä¼ ç»Ÿå‘é‡é‡åŒ–ï¼Œä½†ä¹Ÿå¸¦æ¥äº†æ›´é«˜çš„è®¡ç®—å’Œå®ç°å¤æ‚æ€§ã€‚æ ¹æ®å…·ä½“åº”ç”¨éœ€æ±‚é€‰æ‹©åˆé€‚çš„é‡åŒ–æ–¹æ³•éå¸¸é‡è¦ã€‚</p><p><strong>Residual Quantizationï¼ˆæ®‹å·®é‡åŒ–ï¼ŒRQï¼‰</strong> æ˜¯ä¸€ç§å¤šé˜¶æ®µçš„å‘é‡é‡åŒ–æ–¹æ³•ï¼Œé€šè¿‡é€æ­¥é‡åŒ–æ®‹å·®æ¥æé«˜å‘é‡è¡¨ç¤ºçš„ç²¾åº¦ã€‚åœ¨ <strong>VQ-VAE</strong>ï¼ˆVector Quantized Variational Autoencoderï¼‰ç­‰æ·±åº¦å­¦ä¹ æ¨¡å‹ä¸­ï¼ŒRQ è¢«ç”¨æ¥æ›´æœ‰æ•ˆåœ°ç¦»æ•£åŒ–æ½œåœ¨è¡¨ç¤ºã€‚ä¸ºäº†æ›´å¥½åœ°ç†è§£ RQ çš„å·¥ä½œæœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯æ¯ä¸ªé˜¶æ®µçš„è¾“å…¥å’Œè¾“å‡ºï¼Œä¸‹é¢å°†è¯¦ç»†é˜è¿°è¿™ä¸€è¿‡ç¨‹ã€‚</p><hr><h2 id="1-residual-quantization-çš„æ•´ä½“æµç¨‹"><a class="markdownIt-Anchor" href="#1-residual-quantization-çš„æ•´ä½“æµç¨‹"></a> 1. Residual Quantization çš„æ•´ä½“æµç¨‹</h2><p>åœ¨ Residual Quantization ä¸­ï¼Œå‘é‡é‡åŒ–è¿‡ç¨‹è¢«åˆ†è§£ä¸ºå¤šä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µè´Ÿè´£é‡åŒ–å‰ä¸€é˜¶æ®µæœªèƒ½æ•æ‰åˆ°çš„æ®‹å·®ã€‚æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><strong>ç¼–ç å™¨è¾“å‡º</strong>ï¼šè¾“å…¥æ•°æ®é€šè¿‡ç¼–ç å™¨å¾—åˆ°è¿ç»­çš„æ½œåœ¨è¡¨ç¤º ( z )ã€‚</li><li><strong>é˜¶æ®µ 1 é‡åŒ–</strong>ï¼š<ul><li>ä½¿ç”¨é˜¶æ®µ 1 çš„ä»£ç ä¹¦å°† ( z ) é‡åŒ–ä¸ºåµŒå…¥å‘é‡ ( e_{1k_1} )ã€‚</li><li>è®¡ç®—æ®‹å·® ( r_1 = z - e_{1k_1} )ã€‚</li></ul></li><li><strong>é˜¶æ®µ 2 é‡åŒ–</strong>ï¼š<ul><li>ä½¿ç”¨é˜¶æ®µ 2 çš„ä»£ç ä¹¦å°†æ®‹å·® ( r_1 ) é‡åŒ–ä¸ºåµŒå…¥å‘é‡ ( e_{2k_2} )ã€‚</li><li>è®¡ç®—æ–°çš„æ®‹å·® ( r_2 = r_1 - e_{2k_2} )ã€‚</li></ul></li><li><strong>â€¦</strong></li><li><strong>é˜¶æ®µ K é‡åŒ–</strong>ï¼š<ul><li>ä½¿ç”¨é˜¶æ®µ K çš„ä»£ç ä¹¦å°†æ®‹å·® ( r_{K-1} ) é‡åŒ–ä¸ºåµŒå…¥å‘é‡ ( e_{Kk_K} )ã€‚</li><li>è®¡ç®—æœ€ç»ˆæ®‹å·® ( r_K = r_{K-1} - e_{Kk_K} )ã€‚</li></ul></li><li><strong>é‡æ„</strong>ï¼š<ul><li>å°†æ‰€æœ‰é˜¶æ®µçš„åµŒå…¥å‘é‡ç›¸åŠ ï¼Œå¾—åˆ°é‡æ„è¡¨ç¤º ( \hat{z} = e_{1k_1} + e_{2k_2} + \dots + e_{Kk_K} )ã€‚</li></ul></li></ol><p>é€šè¿‡è¿™ç§å¤šé˜¶æ®µé‡åŒ–ï¼ŒRQ èƒ½å¤Ÿæ›´ç²¾ç¡®åœ°é€¼è¿‘åŸå§‹å‘é‡ ( z )ï¼Œä»è€Œé™ä½é‡åŒ–è¯¯å·®ã€‚</p><h2 id="2-æ¯ä¸ªé˜¶æ®µçš„è¾“å…¥ä¸è¾“å‡º"><a class="markdownIt-Anchor" href="#2-æ¯ä¸ªé˜¶æ®µçš„è¾“å…¥ä¸è¾“å‡º"></a> 2. æ¯ä¸ªé˜¶æ®µçš„è¾“å…¥ä¸è¾“å‡º</h2><h3 id="é˜¶æ®µ-1"><a class="markdownIt-Anchor" href="#é˜¶æ®µ-1"></a> é˜¶æ®µ 1</h3><ul><li><strong>è¾“å…¥</strong>ï¼š<ul><li><strong>åŸå§‹å‘é‡ ( z )</strong>ï¼šæ¥è‡ªç¼–ç å™¨çš„è¿ç»­æ½œåœ¨è¡¨ç¤ºï¼Œå½¢çŠ¶ä¸º ((\text{batch_size}, D, H, W))ã€‚</li></ul></li><li><strong>è¿‡ç¨‹</strong>ï¼š<ol><li><strong>é‡åŒ–</strong>ï¼šä½¿ç”¨é˜¶æ®µ 1 çš„ä»£ç ä¹¦æ‰¾åˆ°ä¸ ( z ) æœ€æ¥è¿‘çš„åµŒå…¥å‘é‡ ( e_{1k_1} )ã€‚</li><li><strong>è®¡ç®—æ®‹å·®</strong>ï¼š( r_1 = z - e_{1k_1} )ã€‚</li></ol></li><li><strong>è¾“å‡º</strong>ï¼š<ul><li><strong>é‡åŒ–å‘é‡ ( e_{1k_1} )</strong>ï¼šæ¥è‡ªä»£ç ä¹¦çš„ç¦»æ•£åµŒå…¥å‘é‡ï¼Œå½¢çŠ¶ä¸ ( z ) ç›¸åŒã€‚</li><li><strong>æ®‹å·® ( r_1 )</strong>ï¼šç”¨äºä¸‹ä¸€é˜¶æ®µé‡åŒ–ã€‚</li></ul></li></ul><h3 id="é˜¶æ®µ-2"><a class="markdownIt-Anchor" href="#é˜¶æ®µ-2"></a> é˜¶æ®µ 2</h3><ul><li><strong>è¾“å…¥</strong>ï¼š<ul><li><strong>æ®‹å·® ( r_1 )</strong>ï¼šæ¥è‡ªé˜¶æ®µ 1 çš„æ®‹å·®ï¼Œå½¢çŠ¶ä¸º ((\text{batch_size}, D, H, W))ã€‚</li></ul></li><li><strong>è¿‡ç¨‹</strong>ï¼š<ol><li><strong>é‡åŒ–</strong>ï¼šä½¿ç”¨é˜¶æ®µ 2 çš„ä»£ç ä¹¦æ‰¾åˆ°ä¸ ( r_1 ) æœ€æ¥è¿‘çš„åµŒå…¥å‘é‡ ( e_{2k_2} )ã€‚</li><li><strong>è®¡ç®—æ®‹å·®</strong>ï¼š( r_2 = r_1 - e_{2k_2} )ã€‚</li></ol></li><li><strong>è¾“å‡º</strong>ï¼š<ul><li><strong>é‡åŒ–å‘é‡ ( e_{2k_2} )</strong>ï¼šæ¥è‡ªä»£ç ä¹¦çš„ç¦»æ•£åµŒå…¥å‘é‡ã€‚</li><li><strong>æ®‹å·® ( r_2 )</strong>ï¼šç”¨äºä¸‹ä¸€é˜¶æ®µé‡åŒ–ã€‚</li></ul></li></ul><h3 id="é˜¶æ®µ-3-åŠä¹‹åçš„é˜¶æ®µ"><a class="markdownIt-Anchor" href="#é˜¶æ®µ-3-åŠä¹‹åçš„é˜¶æ®µ"></a> é˜¶æ®µ 3 åŠä¹‹åçš„é˜¶æ®µ</h3><ul><li><strong>è¾“å…¥</strong>ï¼š<ul><li><strong>æ®‹å·® ( r_{i-1} )</strong>ï¼šæ¥è‡ªå‰ä¸€é˜¶æ®µçš„æ®‹å·®ã€‚</li></ul></li><li><strong>è¿‡ç¨‹</strong>ï¼š<ol><li><strong>é‡åŒ–</strong>ï¼šä½¿ç”¨é˜¶æ®µ ( i ) çš„ä»£ç ä¹¦æ‰¾åˆ°ä¸ ( r_{i-1} ) æœ€æ¥è¿‘çš„åµŒå…¥å‘é‡ ( e_{ik_i} )ã€‚</li><li><strong>è®¡ç®—æ®‹å·®</strong>ï¼š( r_i = r_{i-1} - e_{ik_i} )ã€‚</li></ol></li><li><strong>è¾“å‡º</strong>ï¼š<ul><li><strong>é‡åŒ–å‘é‡ ( e_{ik_i} )</strong>ã€‚</li><li><strong>æ®‹å·® ( r_i )</strong>ã€‚</li></ul></li></ul><h3 id="æœ€ç»ˆè¾“å‡º"><a class="markdownIt-Anchor" href="#æœ€ç»ˆè¾“å‡º"></a> æœ€ç»ˆè¾“å‡º</h3><ul><li><strong>é‡æ„å‘é‡ ( \hat{z} )</strong>ï¼šæ‰€æœ‰é˜¶æ®µçš„é‡åŒ–å‘é‡ç›¸åŠ ï¼Œå³ ( \hat{z} = e_{1k_1} + e_{2k_2} + \dots + e_{Kk_K} )ã€‚</li><li><strong>æŸå¤±</strong>ï¼šæ¯ä¸ªé˜¶æ®µçš„é‡åŒ–æŸå¤±å’Œé‡å»ºæŸå¤±çš„æ€»å’Œã€‚</li><li><strong>å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰</strong>ï¼šç”¨äºç›‘æ§æ¯ä¸ªä»£ç ä¹¦çš„ä½¿ç”¨æƒ…å†µã€‚</li></ul><h2 id="3-å›¾ç¤ºè¯´æ˜"><a class="markdownIt-Anchor" href="#3-å›¾ç¤ºè¯´æ˜"></a> 3. å›¾ç¤ºè¯´æ˜</h2><p>ä»¥ä¸‹æ˜¯ Residual Quantization çš„å¤šé˜¶æ®µé‡åŒ–æµç¨‹å›¾ï¼š</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs 1c">åŸå§‹å‘é‡ z<br>   <span class="hljs-string">|</span><br>   <span class="hljs-string">|---&gt; é˜¶æ®µ1: é‡åŒ– z å¾—åˆ° e1k1, è®¡ç®— r1 = z - e1k1</span><br>   <span class="hljs-string">|</span><br>   <span class="hljs-string">|---&gt; é˜¶æ®µ2: é‡åŒ– r1 å¾—åˆ° e2k2, è®¡ç®— r2 = r1 - e2k2</span><br>   <span class="hljs-string">|</span><br>   <span class="hljs-string">|---&gt; ...</span><br>   <span class="hljs-string">|</span><br>   <span class="hljs-string">|---&gt; é˜¶æ®µK: é‡åŒ– rK-1 å¾—åˆ° eKkK, è®¡ç®— rK = rK-1 - eKkK</span><br>   <span class="hljs-string">|</span><br>é‡æ„å‘é‡<span class="hljs-punctuation">:</span> e1k1 <span class="hljs-punctuation">+</span> e2k2 <span class="hljs-punctuation">+</span> ... <span class="hljs-punctuation">+</span> eKkK<br></code></pre></td></tr></table></figure><h2 id="4-ä»£ç ç¤ºä¾‹ä¸­çš„è¾“å…¥ä¸è¾“å‡º"><a class="markdownIt-Anchor" href="#4-ä»£ç ç¤ºä¾‹ä¸­çš„è¾“å…¥ä¸è¾“å‡º"></a> 4. ä»£ç ç¤ºä¾‹ä¸­çš„è¾“å…¥ä¸è¾“å‡º</h2><p>åŸºäºå‰é¢çš„ä»£ç å®ç°ï¼Œä»¥ä¸‹æ˜¯ Residual Quantizer æ¨¡å—ä¸­æ¯ä¸ªé˜¶æ®µçš„è¾“å…¥ä¸è¾“å‡ºç¤ºä¾‹ã€‚</p><h3 id="ä»£ç æ¨¡å—å›é¡¾"><a class="markdownIt-Anchor" href="#ä»£ç æ¨¡å—å›é¡¾"></a> ä»£ç æ¨¡å—å›é¡¾</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">VectorQuantizer</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_embeddings, embedding_dim, commitment_cost=<span class="hljs-number">0.25</span></span>):<br>        <span class="hljs-built_in">super</span>(VectorQuantizer, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-variable language_">self</span>.num_embeddings = num_embeddings<br>        <span class="hljs-variable language_">self</span>.embedding_dim = embedding_dim<br>        <span class="hljs-variable language_">self</span>.commitment_cost = commitment_cost<br><br>        <span class="hljs-variable language_">self</span>.embedding = nn.Embedding(<span class="hljs-variable language_">self</span>.num_embeddings, <span class="hljs-variable language_">self</span>.embedding_dim)<br>        <span class="hljs-variable language_">self</span>.embedding.weight.data.uniform_(-<span class="hljs-number">1</span>/<span class="hljs-variable language_">self</span>.num_embeddings, <span class="hljs-number">1</span>/<span class="hljs-variable language_">self</span>.num_embeddings)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, inputs</span>):<br>        input_shape = inputs.shape  <span class="hljs-comment"># (batch_size, embedding_dim, height, width)</span><br>        flat_input = inputs.permute(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>).contiguous().view(-<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.embedding_dim)  <span class="hljs-comment"># (N, D)</span><br><br>        <span class="hljs-comment"># è®¡ç®—ä¸æ¯ä¸ªåµŒå…¥å‘é‡çš„è·ç¦»</span><br>        distances = (torch.<span class="hljs-built_in">sum</span>(flat_input ** <span class="hljs-number">2</span>, dim=<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>) +<br>                     torch.<span class="hljs-built_in">sum</span>(<span class="hljs-variable language_">self</span>.embedding.weight ** <span class="hljs-number">2</span>, dim=<span class="hljs-number">1</span>) -<br>                     <span class="hljs-number">2</span> * torch.matmul(flat_input, <span class="hljs-variable language_">self</span>.embedding.weight.t()))  <span class="hljs-comment"># (N, num_embeddings)</span><br><br>        <span class="hljs-comment"># è·å–æœ€è¿‘é‚»ç´¢å¼•</span><br>        encoding_indices = torch.argmin(distances, dim=<span class="hljs-number">1</span>).unsqueeze(<span class="hljs-number">1</span>)  <span class="hljs-comment"># (N, 1)</span><br><br>        <span class="hljs-comment"># å°†ç´¢å¼•è½¬æ¢ä¸º one-hot ç¼–ç </span><br>        device = inputs.device<br>        encodings = torch.zeros(encoding_indices.size(<span class="hljs-number">0</span>), <span class="hljs-variable language_">self</span>.num_embeddings, device=device)<br>        encodings.scatter_(<span class="hljs-number">1</span>, encoding_indices, <span class="hljs-number">1</span>)<br><br>        <span class="hljs-comment"># é‡åŒ–åçš„åµŒå…¥å‘é‡</span><br>        quantized = torch.matmul(encodings, <span class="hljs-variable language_">self</span>.embedding.weight)  <span class="hljs-comment"># (N, D)</span><br>        quantized = quantized.view(input_shape[<span class="hljs-number">0</span>], input_shape[<span class="hljs-number">2</span>], input_shape[<span class="hljs-number">3</span>], <span class="hljs-variable language_">self</span>.embedding_dim)<br>        quantized = quantized.permute(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>).contiguous()  <span class="hljs-comment"># (batch_size, D, H, W)</span><br><br>        <span class="hljs-comment"># è®¡ç®—æŸå¤±</span><br>        e_latent_loss = F.mse_loss(quantized.detach(), inputs)<br>        q_latent_loss = F.mse_loss(quantized, inputs.detach())<br>        loss = q_latent_loss + <span class="hljs-variable language_">self</span>.commitment_cost * e_latent_loss<br><br>        <span class="hljs-comment"># æ·»åŠ ç›´é€šä¼°è®¡å™¨çš„æ¢¯åº¦</span><br>        quantized = inputs + (quantized - inputs).detach()<br><br>        <span class="hljs-comment"># è®¡ç®— perplexityï¼ˆå›°æƒ‘åº¦ï¼‰</span><br>        avg_probs = torch.mean(encodings, dim=<span class="hljs-number">0</span>)<br>        perplexity = torch.exp(-torch.<span class="hljs-built_in">sum</span>(avg_probs * torch.log(avg_probs + <span class="hljs-number">1e-10</span>)))<br><br>        <span class="hljs-keyword">return</span> quantized, loss, perplexity, encoding_indices<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ResidualQuantizer</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_quantizers, num_embeddings, embedding_dim, commitment_cost=<span class="hljs-number">0.25</span></span>):<br>        <span class="hljs-built_in">super</span>(ResidualQuantizer, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-variable language_">self</span>.num_quantizers = num_quantizers<br>        <span class="hljs-variable language_">self</span>.quantizers = nn.ModuleList([<br>            VectorQuantizer(num_embeddings, embedding_dim, commitment_cost)<br>            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_quantizers)<br>        ])<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, inputs</span>):<br>        residual = inputs<br>        quantized = torch.zeros_like(inputs)<br>        total_loss = <span class="hljs-number">0.0</span><br>        total_perplexity = <span class="hljs-number">0.0</span><br>        encoding_indices = []<br><br>        <span class="hljs-keyword">for</span> quantizer <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.quantizers:<br>            q, loss, perplexity, indices = quantizer(residual)<br>            quantized += q<br>            total_loss += loss<br>            total_perplexity += perplexity<br>            encoding_indices.append(indices)<br>            residual = residual - q<br><br>        <span class="hljs-keyword">return</span> quantized, total_loss, total_perplexity, encoding_indices<br></code></pre></td></tr></table></figure><h3 id="è®­ç»ƒå¾ªç¯ä¸­çš„è¾“å…¥ä¸è¾“å‡º"><a class="markdownIt-Anchor" href="#è®­ç»ƒå¾ªç¯ä¸­çš„è¾“å…¥ä¸è¾“å‡º"></a> è®­ç»ƒå¾ªç¯ä¸­çš„è¾“å…¥ä¸è¾“å‡º</h3><p>åœ¨è®­ç»ƒå¾ªç¯ä¸­ï¼Œæ¯ä¸ªé‡åŒ–é˜¶æ®µçš„è¾“å…¥å’Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):<br>    model.train()<br>    <span class="hljs-keyword">for</span> batch_idx, (data, _) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_loader):<br>        data = data.to(device)<br><br>        optimizer.zero_grad()<br>        x_recon, loss_q, perplexity, encoding_indices = model(data)<br><br>        <span class="hljs-comment"># è®¡ç®—é‡å»ºæŸå¤±ï¼ˆMSEï¼‰</span><br>        recon_loss = F.mse_loss(x_recon, data)<br><br>        <span class="hljs-comment"># æ€»æŸå¤±</span><br>        loss = recon_loss + loss_q<br><br>        <span class="hljs-comment"># åå‘ä¼ æ’­å’Œä¼˜åŒ–</span><br>        loss.backward()<br>        optimizer.step()<br></code></pre></td></tr></table></figure><p><strong>è¯¦ç»†è§£é‡Š</strong>ï¼š</p><ol><li><p><strong>ç¼–ç å™¨è¾“å‡º</strong>ï¼š</p><ul><li><strong>è¾“å…¥</strong>ï¼šåŸå§‹å›¾åƒ <code>data</code>ï¼Œå½¢çŠ¶ä¸º ((\text{batch_size}, 3, 32, 32))ï¼ˆä»¥ CIFAR-10 ä¸ºä¾‹ï¼‰ã€‚</li><li><strong>è¾“å‡º</strong>ï¼šç¼–ç å™¨ç”Ÿæˆçš„è¿ç»­æ½œåœ¨è¡¨ç¤º ( z )ï¼Œå½¢çŠ¶ä¸º ((\text{batch_size}, D, H, W))ã€‚</li></ul></li><li><p><strong>Residual Quantizer å‰å‘ä¼ æ’­</strong>ï¼š</p><ul><li><strong>è¾“å…¥</strong>ï¼šç¼–ç å™¨è¾“å‡º ( z )ã€‚</li><li><strong>è¿‡ç¨‹</strong>ï¼š<ul><li><strong>é˜¶æ®µ 1</strong>ï¼š<ul><li><strong>è¾“å…¥</strong>ï¼š( z )ã€‚</li><li><strong>è¾“å‡º</strong>ï¼šé‡åŒ–å‘é‡ ( e_{1k_1} )ï¼ŒæŸå¤± ( \mathcal{L}_{1} )ï¼Œå›°æƒ‘åº¦ ( P_1 )ï¼Œç¼–ç ç´¢å¼• ( k_1 )ã€‚</li><li><strong>æ®‹å·®</strong>ï¼š( r_1 = z - e_{1k_1} )ã€‚</li></ul></li><li><strong>é˜¶æ®µ 2</strong>ï¼š<ul><li><strong>è¾“å…¥</strong>ï¼šæ®‹å·® ( r_1 )ã€‚</li><li><strong>è¾“å‡º</strong>ï¼šé‡åŒ–å‘é‡ ( e_{2k_2} )ï¼ŒæŸå¤± ( \mathcal{L}_{2} )ï¼Œå›°æƒ‘åº¦ ( P_2 )ï¼Œç¼–ç ç´¢å¼• ( k_2 )ã€‚</li><li><strong>æ®‹å·®</strong>ï¼š( r_2 = r_1 - e_{2k_2} )ã€‚</li></ul></li><li><strong>â€¦</strong></li><li><strong>é˜¶æ®µ K</strong>ï¼š<ul><li><strong>è¾“å…¥</strong>ï¼šæ®‹å·® ( r_{K-1} )ã€‚</li><li><strong>è¾“å‡º</strong>ï¼šé‡åŒ–å‘é‡ ( e_{Kk_K} )ï¼ŒæŸå¤± ( \mathcal{L}_{K} )ï¼Œå›°æƒ‘åº¦ ( P_K )ï¼Œç¼–ç ç´¢å¼• ( k_K )ã€‚</li><li><strong>æ®‹å·®</strong>ï¼š( r_K = r_{K-1} - e_{Kk_K} )ã€‚</li></ul></li></ul></li><li><strong>è¾“å‡ºæ€»é‡åŒ–å‘é‡</strong>ï¼š( \hat{z} = e_{1k_1} + e_{2k_2} + \dots + e_{Kk_K} )ã€‚</li><li><strong>æ€»æŸå¤±</strong>ï¼š( \mathcal{L}<em>{\text{quant}} = \mathcal{L}</em>{1} + \mathcal{L}<em>{2} + \dots + \mathcal{L}</em>{K} )ã€‚</li><li><strong>æ€»å›°æƒ‘åº¦</strong>ï¼š( P_{\text{total}} = P_1 + P_2 + \dots + P_K )ã€‚</li><li><strong>ç¼–ç ç´¢å¼•</strong>ï¼šæ‰€æœ‰é˜¶æ®µçš„ç¼–ç ç´¢å¼• ( [k_1, k_2, \dots, k_K] )ã€‚</li></ul></li><li><p><strong>è§£ç å™¨</strong>ï¼š</p><ul><li><strong>è¾“å…¥</strong>ï¼šé‡æ„å‘é‡ ( \hat{z} )ã€‚</li><li><strong>è¾“å‡º</strong>ï¼šé‡æ„å›¾åƒ ( \hat{x} )ï¼Œå½¢çŠ¶ä¸åŸå§‹å›¾åƒç›¸åŒã€‚</li></ul></li><li><p><strong>æŸå¤±è®¡ç®—</strong>ï¼š</p><ul><li><strong>é‡å»ºæŸå¤±</strong>ï¼š( \mathcal{L}_{\text{recon}} = \text{MSE}(\hat{x}, x) )ã€‚</li><li><strong>æ€»æŸå¤±</strong>ï¼š( \mathcal{L} = \mathcal{L}<em>{\text{recon}} + \mathcal{L}</em>{\text{quant}} )ã€‚</li></ul></li><li><p><strong>ä¼˜åŒ–</strong>ï¼š</p><ul><li>é€šè¿‡åå‘ä¼ æ’­å’Œä¼˜åŒ–å™¨æ›´æ–°æ¨¡å‹å‚æ•°ï¼ŒåŒ…æ‹¬ç¼–ç å™¨ã€è§£ç å™¨å’Œæ‰€æœ‰é‡åŒ–é˜¶æ®µçš„ä»£ç ä¹¦ã€‚</li></ul></li></ol><h2 id="5-æ€»ç»“"><a class="markdownIt-Anchor" href="#5-æ€»ç»“"></a> 5. æ€»ç»“</h2><p>åœ¨ Residual Quantization ä¸­ï¼Œæ¯ä¸ªé‡åŒ–é˜¶æ®µçš„è¾“å…¥å’Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><ul><li><p><strong>è¾“å…¥</strong>ï¼š</p><ul><li><strong>é˜¶æ®µ 1</strong>ï¼šåŸå§‹çš„è¿ç»­æ½œåœ¨è¡¨ç¤º ( z )ã€‚</li><li><strong>é˜¶æ®µ 2</strong>ï¼šé˜¶æ®µ 1 çš„æ®‹å·® ( r_1 )ã€‚</li><li><strong>é˜¶æ®µ 3</strong>ï¼šé˜¶æ®µ 2 çš„æ®‹å·® ( r_2 )ã€‚</li><li><strong>â€¦</strong></li><li><strong>é˜¶æ®µ K</strong>ï¼šé˜¶æ®µ ( K-1 ) çš„æ®‹å·® ( r_{K-1} )ã€‚</li></ul></li><li><p><strong>è¾“å‡º</strong>ï¼š</p><ul><li><strong>é‡åŒ–å‘é‡</strong>ï¼šæ¯ä¸ªé˜¶æ®µé‡åŒ–åçš„åµŒå…¥å‘é‡ ( e_{ik_i} )ã€‚</li><li><strong>æ®‹å·®</strong>ï¼šæ¯ä¸ªé˜¶æ®µé‡åŒ–åçš„æ®‹å·® ( r_i = r_{i-1} - e_{ik_i} )ã€‚</li><li><strong>æŸå¤±</strong>ï¼šæ¯ä¸ªé˜¶æ®µçš„é‡åŒ–æŸå¤± ( \mathcal{L}_{i} )ã€‚</li><li><strong>å›°æƒ‘åº¦</strong>ï¼šæ¯ä¸ªé˜¶æ®µçš„å›°æƒ‘åº¦ ( P_i )ï¼Œç”¨äºç›‘æ§ä»£ç ä¹¦çš„ä½¿ç”¨æƒ…å†µã€‚</li><li><strong>ç¼–ç ç´¢å¼•</strong>ï¼šæ¯ä¸ªé˜¶æ®µé€‰æ‹©çš„åµŒå…¥å‘é‡çš„ç´¢å¼• ( k_i )ã€‚</li></ul></li></ul><p>é€šè¿‡å¤šé˜¶æ®µé‡åŒ–ï¼ŒResidual Quantization èƒ½å¤Ÿé€æ­¥é€¼è¿‘åŸå§‹å‘é‡ï¼Œæé«˜é‡åŒ–ç²¾åº¦ï¼Œé€‚ç”¨äºéœ€è¦é«˜ç²¾åº¦å‘é‡è¡¨ç¤ºçš„ä»»åŠ¡ã€‚åœ¨æ·±åº¦å­¦ä¹ æ¨¡å‹ä¸­ï¼Œç»“åˆç›´é€šä¼°è®¡å™¨å’Œé€‚å½“çš„æŸå¤±å‡½æ•°è®¾è®¡ï¼ŒRQ å¯ä»¥å®ç°é«˜æ•ˆä¸”å‡†ç¡®çš„æ½œåœ¨ç©ºé—´ç¦»æ•£åŒ–ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>StageDesigner</title>
    <link href="/2025/01/03/StageDesigner/"/>
    <url>/2025/01/03/StageDesigner/</url>
    
    <content type="html"><![CDATA[<h1 id="stagedesigner-artistic-stage-generation-for-scenography-via-theater-scripts-cvpr-2025"><a class="markdownIt-Anchor" href="#stagedesigner-artistic-stage-generation-for-scenography-via-theater-scripts-cvpr-2025"></a> StageDesigner: Artistic Stage Generation for Scenography via Theater Scripts (CVPR 2025)</h1><div align="center"><b>Zhaoxing GanÂ¹, Mengtian LiÂ¹Â²â€ , Ruhua ChenÂ³, Zhongxia JiÂ³,  Sichen GuoÂ³, Huanling HuÂ¹, Guangnan YeÂ¹â€ , Zuo HuÂ³</b><p>Â¹Fudan University, Â²Shanghai University, Â³Shanghai Theatre Academy</p><p>ğŸ“§ <a href="mailto:zxgan23@m.fudan.edu.cn">zxgan23@m.fudan.edu.cn</a>, <a href="mailto:mtli@shu.edu.cn">mtli@shu.edu.cn</a>, <a href="mailto:yegn@fudan.edu.cn">yegn@fudan.edu.cn</a>, {chenruhua, zhongxia.ji, huzuo}@sta.edu.cn</p><div><style>    .buttons {        margin-top: 10px;        display: flex;        justify-content: center;        gap: 15px;    }    .buttons a {        text-decoration: none;        font-size: 0.9em;        color: #fff;        display: flex;        align-items: center;        justify-content: center;        padding: 8px 12px;        background-color: #333;        border-radius: 20px;        transition: background-color 0.3s;    }    .buttons a img {        vertical-align: middle;        width: 16px;        height: 16px;        margin-right: 5px;    }    .buttons a:hover {        background-color: #555;    }</style><div class="buttons">    <a href="#" class="button">        <img src="/2025/01/03/StageDesigner/paper.png" alt="Paper Icon"> Paper    </a>    <a href="#" class="button">        <img src="/2025/01/03/StageDesigner/arxiv.png" alt="arXiv Icon"> arXiv    </a>    <a href="https://github.com/deadsmither5/StageDesigner" class="button">        <img src="/2025/01/03/StageDesigner/github.png" alt="Code Icon"> Code    </a>    <a href="#" class="button">        <img src="/2025/01/03/StageDesigner/hug.png" alt="Dataset Icon"> Dataset    </a></div><div style="text-align: center; margin: 40px 0;">    <video width="800" height="450" autoplay muted controls>        <source src="demo.mp4" type="video/mp4">        Your browser does not support the video tag.    </video></div><h2 id="abstract"><a class="markdownIt-Anchor" href="#abstract"></a> Abstract</h2><p>In this work, we introduce <strong>StageDesigner</strong>, the first comprehensive framework for artistic stage generation using large language models (LLMs) combined with layout-controlled diffusion models. Given the professional requirements of stage scenography, StageDesigner simulates the workflows of seasoned artists to generate immersive 3D stage scenes. Specifically, our approach is divided into three primary modules: <em>Script Analysis</em>, which extracts thematic and spatial cues from input scripts; <em>Foreground Generation</em>, which constructs and arranges essential 3D objects; and <em>Background Generation</em>, which produces a harmonious background aligned with the narrative atmosphere and maintains spatial coherence by managing occlusions between foreground and background elements. Furthermore, we introduce the <strong>StagePro-V1</strong> dataset, a dedicated dataset with 276 unique stage scenes spanning different historical styles and annotated with scripts, images, and detailed 3D layouts, specifically tailored for this task. Finally, evaluations using both standard and newly proposed metrics, along with extensive user studies, demonstrate the effectiveness of StageDesigner, showcasing its ability to produce visually and thematically cohesive stages that meet both artistic and spatial coherence standards.</p><h2 id="framework"><a class="markdownIt-Anchor" href="#framework"></a> Framework</h2><p>StageDesigner is a novel framework for generating immersive artistic stage designs from theater scripts. It combines large language models (LLMs) with layout-controlled diffusion models to create 3D stage layouts, aligning foreground and background elements seamlessly. Our approach empowers both general users and professional designers with AI-driven tools for scenography.</p><p><img src="/2025/01/03/StageDesigner/pipeline.png" alt="Project Description Image"></p><h2 id="stagepro-v1-dataset"><a class="markdownIt-Anchor" href="#stagepro-v1-dataset"></a> StagePro-V1 Dataset</h2><p>The StagePro-V1 dataset, created specifically for this project, spans decades of stage design and includes richly annotated scripts, stage images, and 3D layouts. The dataset features:</p><ul><li>276 unique stage productions from the 1940s to the 2020s.</li><li>Detailed script annotations with spatial and thematic cues.</li><li>Diverse artistic styles, reflecting real-world scenography practices.</li></ul><p>Below are some stage examples from the dataset:</p><table><thead><tr><th style="text-align:center"><img src="/2025/01/03/StageDesigner/The%20Cruel%20Game.png" alt="The Cruel Game"></th><th style="text-align:center"><img src="/2025/01/03/StageDesigner/Beyond%20the%20Horizon.png" alt="Beyond the Horizon"></th></tr></thead><tbody><tr><td style="text-align:center"><strong>The Cruel Game</strong></td><td style="text-align:center"><strong>Beyond the Horizon</strong></td></tr></tbody></table><table><thead><tr><th style="text-align:center"><img src="/2025/01/03/StageDesigner/Lend%20me%20a%20Tenor.png" alt="Lend me a Tenor"></th><th style="text-align:center"><img src="/2025/01/03/StageDesigner/Shooting%20Star.png" alt="Shooting Star"></th></tr></thead><tbody><tr><td style="text-align:center"><strong>Lend me a Tenor</strong></td><td style="text-align:center"><strong>Shooting Star</strong></td></tr></tbody></table><h2 id="generated-stages"><a class="markdownIt-Anchor" href="#generated-stages"></a> Generated Stages</h2><p>Below are examples of outputs generated by StageDesigner, including cohesive 3D layouts and atmospherically aligned backgrounds:</p><table><thead><tr><th style="text-align:center"><img src="/2025/01/03/StageDesigner/Favoritsim.png" alt="Favoritism"></th><th style="text-align:center"><img src="/2025/01/03/StageDesigner/Withered%20Trees%20Blossom%20Again.png" alt="Withered Trees Blossom Again"></th></tr></thead><tbody><tr><td style="text-align:center"><strong>Favoritism</strong></td><td style="text-align:center"><strong>Withered Trees Blossom Again</strong></td></tr></tbody></table><table><thead><tr><th style="text-align:center"><img src="/2025/01/03/StageDesigner/The%20Godfather.png" alt="The Godfather"></th><th style="text-align:center"><img src="/2025/01/03/StageDesigner/The%20Diary%20of%20Anne%20Frank.png" alt="The Diary of Anne Frank"></th></tr></thead><tbody><tr><td style="text-align:center"><strong>The Godfather</strong></td><td style="text-align:center"><strong>The Diary of Anne Frank</strong></td></tr></tbody></table><hr><p><strong>More details are coming soon</strong></p></div></div>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>è´å¡å°”æ›²çº¿</title>
    <link href="/2024/12/30/%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF/"/>
    <url>/2024/12/30/%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>pythonè£…é¥°å™¨</title>
    <link href="/2024/12/29/python%E8%A3%85%E9%A5%B0%E5%99%A8/"/>
    <url>/2024/12/29/python%E8%A3%85%E9%A5%B0%E5%99%A8/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>classmethodè¯¦è§£</title>
    <link href="/2024/12/29/classmethod%E8%AF%A6%E8%A7%A3/"/>
    <url>/2024/12/29/classmethod%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>vaeä»£ç é˜…è¯»</title>
    <link href="/2024/12/28/vae%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    <url>/2024/12/28/vae%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/</url>
    
    <content type="html"><![CDATA[<p>åœ¨é˜…è¯»fluxä»£ç (pipeline_flux.Fluxpipelineç±»ä¸­çš„__call__æ–¹æ³•æœ€åå‡ å¥)å¯¹diffusioné‡‡æ ·å¾—åˆ°çš„latentè½¬æ¢å›vaeè¾“å…¥çš„è¿™æ®µä»£ç æ—¶ï¼Œçœ‹åˆ°æ ‡è“è¿™æ®µä»£ç å¾ˆç–‘æƒ‘ï¼Œå› æ­¤æ‰“ç®—å¤ä¹ ä¸€ä¸‹vaeï¼Œç ”ç©¶ä¸€ä¸‹<strong>ä¸ºä»€ä¹ˆè¦ä¹˜ä»¥ç¼©æ”¾ç³»æ•°ä»¥åŠè¿›è¡Œåç½®ã€‚</strong></p><p>æŸ¥é˜…ç½‘ä¸Šåšå®¢åï¼Œæœ‰äººè¯´æ˜¯<strong>å› ä¸ºpixel spaceå˜æˆlatent spaceä¹‹åçš„å€¼éƒ½ç‰¹åˆ«å¤§ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªç¼©æ”¾å› å­æ¥è®©èŒƒå›´å˜å°ï¼ŒåŒæ—¶è¿›è¡Œåç½®ä½¿å¾—èŒƒå›´åˆç†ã€‚</strong> è¿™æ˜¯æˆ‘è®¤ä¸ºæ¯”è¾ƒæ­£ç¡®çš„ç†è§£ã€‚</p><p>å®˜æ–¹æ–‡æ¡£çš„è§£é‡Šï¼š<a href="https://huggingface.co/docs/diffusers/main/en/api/models/autoencoderkl">https://huggingface.co/docs/diffusers/main/en/api/models/autoencoderkl</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> output_type == <span class="hljs-string">&quot;latent&quot;</span>:<br>    image = latents<br><br><span class="hljs-keyword">else</span>:<br>    latents = <span class="hljs-variable language_">self</span>._unpack_latents(latents, height, width, <span class="hljs-variable language_">self</span>.vae_scale_factor)<br>   <span class="hljs-string">&#x27;latents = (latents / self.vae.config.scaling_factor) + self.vae.config.shift_factor&#x27;</span><br>    image = <span class="hljs-variable language_">self</span>.vae.decode(latents, return_dict=<span class="hljs-literal">False</span>)[<span class="hljs-number">0</span>]<br>    image = <span class="hljs-variable language_">self</span>.image_processor.postprocess(image, output_type=output_type)<br></code></pre></td></tr></table></figure><h2 id="åŸç†è§£æ"><a class="markdownIt-Anchor" href="#åŸç†è§£æ"></a> åŸç†è§£æ</h2><p>ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ç»„æˆï¼š</p><ul><li><strong>ç¼–ç å™¨ï¼ˆEncoderï¼‰</strong>ï¼šå°†è¾“å…¥æ•°æ® $ x $ æ˜ å°„åˆ°æ½œåœ¨ç©ºé—´ $ \mathbf{z} $ã€‚</li><li><strong>è§£ç å™¨ï¼ˆDecoderï¼‰</strong>ï¼šå°†æ½œåœ¨è¡¨ç¤º $ \mathbf{z} $ é‡æ„å›åŸå§‹æ•°æ®ç©ºé—´ $ \mathbf{x}â€™ $ã€‚</li></ul><p>VAEå°†æ•°æ®ç”Ÿæˆè¿‡ç¨‹å»ºæ¨¡ä¸ºä¸€ä¸ªæ¦‚ç‡è¿‡ç¨‹ï¼š</p><ol><li><p><strong>æ½œåœ¨å˜é‡çš„å…ˆéªŒåˆ†å¸ƒ</strong>ï¼šå‡è®¾æ½œåœ¨å˜é‡ $ \mathbf{z} $ æœä»æŸä¸ªå…ˆéªŒåˆ†å¸ƒï¼Œé€šå¸¸é€‰æ‹©æ ‡å‡†æ­£æ€åˆ†å¸ƒï¼š</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi mathvariant="bold">z</mi><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mn mathvariant="bold">0</mn><mo separator="true">,</mo><mi mathvariant="bold">I</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(\mathbf{z}) = \mathcal{N}(\mathbf{0}, \mathbf{I})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">z</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">0</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">I</span></span><span class="mclose">)</span></span></span></span></span></p></li><li><p><strong>ç”Ÿæˆæ¨¡å‹</strong>ï¼šç»™å®šæ½œåœ¨å˜é‡ $ \mathbf{z} $ï¼Œç”Ÿæˆæ•°æ® $ \mathbf{x} $ çš„æ¡ä»¶åˆ†å¸ƒï¼š</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mi mathvariant="normal">âˆ£</mi><mi mathvariant="bold">z</mi><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi>Î¼</mi><mo stretchy="false">(</mo><mi mathvariant="bold">z</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msup><mi>Ïƒ</mi><mn>2</mn></msup><mo stretchy="false">(</mo><mi mathvariant="bold">z</mi><mo stretchy="false">)</mo><mi mathvariant="bold">I</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(\mathbf{x}|\mathbf{z}) = \mathcal{N}(\mu(\mathbf{z}), \sigma^2(\mathbf{z})\mathbf{I})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathbf">z</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="mopen">(</span><span class="mord mathnormal">Î¼</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">z</span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">z</span></span><span class="mclose">)</span><span class="mord"><span class="mord mathbf">I</span></span><span class="mclose">)</span></span></span></span></span></p><p>å…¶ä¸­ï¼Œ$ \mu(\mathbf{z}) $ å’Œ $ \sigma(\mathbf{z}) $ ç”±è§£ç å™¨ç½‘ç»œå‚æ•°åŒ–ã€‚</p></li></ol><p>ç›´æ¥è®¡ç®—åéªŒåˆ†å¸ƒ $ p(\mathbf{z}|\mathbf{x}) $ é€šå¸¸éå¸¸å›°éš¾ï¼Œå› æ­¤VAEä½¿ç”¨å˜åˆ†æ¨æ–­ï¼Œé€šè¿‡å¼•å…¥ä¸€ä¸ªå¯å‚æ•°åŒ–çš„è¿‘ä¼¼åˆ†å¸ƒ $ q(\mathbf{z}|\mathbf{x}) $ æ¥é€¼è¿‘çœŸå®çš„åéªŒåˆ†å¸ƒã€‚</p><p>ä¸ºäº†è®­ç»ƒæ¨¡å‹ï¼ŒVAEæœ€å¤§åŒ–è¯æ®ä¸‹ç•Œï¼ˆEvidence Lower Bound, ELBOï¼‰ï¼š</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>log</mi><mo>â¡</mo><mi>p</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>â‰¥</mo><msub><mi mathvariant="double-struck">E</mi><mrow><mi>q</mi><mo stretchy="false">(</mo><mi mathvariant="bold">z</mi><mi mathvariant="normal">âˆ£</mi><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow></msub><mo stretchy="false">[</mo><mi>log</mi><mo>â¡</mo><mi>p</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mi mathvariant="normal">âˆ£</mi><mi mathvariant="bold">z</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo>âˆ’</mo><mtext>KL</mtext><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">(</mo><mi mathvariant="bold">z</mi><mi mathvariant="normal">âˆ£</mi><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mi mathvariant="normal">âˆ£</mi><mi mathvariant="normal">âˆ£</mi><mi>p</mi><mo stretchy="false">(</mo><mi mathvariant="bold">z</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\log p(\mathbf{x}) \geq \mathbb{E}_{q(\mathbf{z}|\mathbf{x})} [\log p(\mathbf{x}|\mathbf{z})] - \text{KL}(q(\mathbf{z}|\mathbf{x}) || p(\mathbf{z}))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">â‰¥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1052em;vertical-align:-0.3551999999999999em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathbf mtight">z</span></span><span class="mord mtight">âˆ£</span><span class="mord mtight"><span class="mord mathbf mtight">x</span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3551999999999999em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathbf">z</span></span><span class="mclose">)</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">KL</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">z</span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathbf">x</span></span><span class="mclose">)</span><span class="mord">âˆ£</span><span class="mord">âˆ£</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">z</span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p><p>å…¶ä¸­ï¼š</p><ul><li><p><strong>é‡æ„é¡¹</strong>ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="double-struck">E</mi><mrow><mi>q</mi><mo stretchy="false">(</mo><mi mathvariant="bold">z</mi><mi mathvariant="normal">âˆ£</mi><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow></msub><mo stretchy="false">[</mo><mi>log</mi><mo>â¡</mo><mi>p</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mi mathvariant="normal">âˆ£</mi><mi mathvariant="bold">z</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\mathbb{E}_{q(\mathbf{z}|\mathbf{x})} [\log p(\mathbf{x}|\mathbf{z})]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1052em;vertical-align:-0.3551999999999999em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathbf mtight">z</span></span><span class="mord mtight">âˆ£</span><span class="mord mtight"><span class="mord mathbf mtight">x</span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3551999999999999em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathbf">z</span></span><span class="mclose">)</span><span class="mclose">]</span></span></span></span></p><ul><li>è¡¡é‡æ¨¡å‹é‡æ„æ•°æ®çš„èƒ½åŠ›ã€‚</li></ul></li><li><p><strong>æ­£åˆ™åŒ–é¡¹</strong>ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>KL</mtext><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">(</mo><mi mathvariant="bold">z</mi><mi mathvariant="normal">âˆ£</mi><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mi mathvariant="normal">âˆ£</mi><mi mathvariant="normal">âˆ£</mi><mi>p</mi><mo stretchy="false">(</mo><mi mathvariant="bold">z</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{KL}(q(\mathbf{z}|\mathbf{x}) || p(\mathbf{z}))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">KL</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">z</span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathbf">x</span></span><span class="mclose">)</span><span class="mord">âˆ£</span><span class="mord">âˆ£</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">z</span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></p><ul><li>è¡¡é‡è¿‘ä¼¼åéªŒåˆ†å¸ƒä¸å…ˆéªŒåˆ†å¸ƒä¹‹é—´çš„å·®å¼‚ï¼Œç¡®ä¿æ½œåœ¨ç©ºé—´çš„è¿ç»­æ€§å’Œè§„åˆ™æ€§ã€‚</li></ul></li></ul><p>VAEçš„æŸå¤±å‡½æ•°ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p><ol><li><p><strong>é‡æ„æŸå¤±ï¼ˆReconstruction Lossï¼‰</strong>ï¼š</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">L</mi><mtext>recon</mtext></msub><mo>=</mo><mo>âˆ’</mo><msub><mi mathvariant="double-struck">E</mi><mrow><mi>q</mi><mo stretchy="false">(</mo><mi mathvariant="bold">z</mi><mi mathvariant="normal">âˆ£</mi><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow></msub><mo stretchy="false">[</mo><mi>log</mi><mo>â¡</mo><mi>p</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mi mathvariant="normal">âˆ£</mi><mi mathvariant="bold">z</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\text{recon}} = -\mathbb{E}_{q(\mathbf{z}|\mathbf{x})} [\log p(\mathbf{x}|\mathbf{z})]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">recon</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1052em;vertical-align:-0.3551999999999999em;"></span><span class="mord">âˆ’</span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathbf mtight">z</span></span><span class="mord mtight">âˆ£</span><span class="mord mtight"><span class="mord mathbf mtight">x</span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3551999999999999em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathbf">z</span></span><span class="mclose">)</span><span class="mclose">]</span></span></span></span></span></p><p>é€šå¸¸ä½¿ç”¨å‡æ–¹è¯¯å·®ï¼ˆMSEï¼‰æˆ–äº¤å‰ç†µä½œä¸ºå…·ä½“å½¢å¼ã€‚</p></li><li><p><strong>KLæ•£åº¦æŸå¤±ï¼ˆKL Divergence Lossï¼‰</strong>ï¼š</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">L</mi><mtext>KL</mtext></msub><mo>=</mo><mtext>KL</mtext><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">(</mo><mi mathvariant="bold">z</mi><mi mathvariant="normal">âˆ£</mi><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mi mathvariant="normal">âˆ£</mi><mi mathvariant="normal">âˆ£</mi><mi>p</mi><mo stretchy="false">(</mo><mi mathvariant="bold">z</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\text{KL}} = \text{KL}(q(\mathbf{z}|\mathbf{x}) || p(\mathbf{z}))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">KL</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">KL</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">z</span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathbf">x</span></span><span class="mclose">)</span><span class="mord">âˆ£</span><span class="mord">âˆ£</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">z</span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p><p>å¯¹äºé«˜æ–¯åˆ†å¸ƒï¼Œå¯ä»¥è®¡ç®—è§£æè§£ï¼š</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>KL</mtext><mo stretchy="false">(</mo><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi>Î¼</mi><mo separator="true">,</mo><msup><mi>Ïƒ</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mi mathvariant="normal">âˆ£</mi><mi mathvariant="normal">âˆ£</mi><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><mo>âˆ’</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><munderover><mo>âˆ‘</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>d</mi></munderover><mrow><mo fence="true">(</mo><mn>1</mn><mo>+</mo><mi>log</mi><mo>â¡</mo><mo stretchy="false">(</mo><msubsup><mi>Ïƒ</mi><mi>i</mi><mn>2</mn></msubsup><mo stretchy="false">)</mo><mo>âˆ’</mo><msubsup><mi>Î¼</mi><mi>i</mi><mn>2</mn></msubsup><mo>âˆ’</mo><msubsup><mi>Ïƒ</mi><mi>i</mi><mn>2</mn></msubsup><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\text{KL}(\mathcal{N}(\mu, \sigma^2) || \mathcal{N}(0, 1)) = -\frac{1}{2} \sum_{i=1}^{d} \left(1 + \log(\sigma_i^2) - \mu_i^2 - \sigma_i^2\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">KL</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="mopen">(</span><span class="mord mathnormal">Î¼</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">âˆ£</span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.1137820000000005em;vertical-align:-1.277669em;"></span><span class="mord">âˆ’</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8361130000000003em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal">Î¼</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span></span></p></li></ol><p>æœ€ç»ˆçš„VAEæŸå¤±å‡½æ•°ä¸ºï¼š</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">L</mi><mo>=</mo><msub><mi mathvariant="script">L</mi><mtext>recon</mtext></msub><mo>+</mo><mi>Î²</mi><msub><mi mathvariant="script">L</mi><mtext>KL</mtext></msub></mrow><annotation encoding="application/x-tex">\mathcal{L} = \mathcal{L}_{\text{recon}} + \beta \mathcal{L}_{\text{KL}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal">L</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">recon</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">KL</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>å…¶ä¸­ï¼Œ$ \beta $ æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œç”¨äºæ§åˆ¶é‡æ„æŸå¤±å’ŒKLæ•£åº¦æŸå¤±ä¹‹é—´çš„æƒè¡¡ã€‚</p><p><strong>è®­ç»ƒé˜¶æ®µ</strong></p><ol><li><p><strong>ç¼–ç </strong>ï¼š</p><ul><li>è¾“å…¥æ•°æ® $ \mathbf{x} $ é€šè¿‡ç¼–ç å™¨ç½‘ç»œï¼Œè¾“å‡ºæ½œåœ¨å˜é‡çš„å‚æ•° $ \mu(\mathbf{x}) $ å’Œ $ \log \sigma^2(\mathbf{x}) $ã€‚</li></ul></li><li><p><strong>é‡å‚æ•°åŒ–æŠ€å·§ï¼ˆReparameterization Trickï¼‰</strong>ï¼š</p><ul><li>ä¸ºäº†å®ç°åå‘ä¼ æ’­ï¼Œä½¿ç”¨é‡å‚æ•°åŒ–æŠ€å·§ä» $ q(\mathbf{z}|\mathbf{x}) = \mathcal{N}(\mu(\mathbf{x}), \sigma^2(\mathbf{x})\mathbf{I}) $ ä¸­é‡‡æ ·ï¼š<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="bold">z</mi><mo>=</mo><mi>Î¼</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>+</mo><mi>Ïƒ</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>âŠ™</mo><mi>Ïµ</mi><mo separator="true">,</mo><mspace width="1em"><mi>Ïµ</mi><mo>âˆ¼</mo><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="bold">I</mi><mo stretchy="false">)</mo></mspace></mrow><annotation encoding="application/x-tex">\mathbf{z} = \mu(\mathbf{x}) + \sigma(\mathbf{x}) \odot \epsilon, \quad \epsilon \sim \mathcal{N}(0, \mathbf{I})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.44444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">z</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Î¼</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">Ïµ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">Ïµ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">âˆ¼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">I</span></span><span class="mclose">)</span></span></span></span></span></p></li></ul></li><li><p><strong>è§£ç </strong>ï¼š</p><ul><li>æ½œåœ¨å˜é‡ $ \mathbf{z} $ é€šè¿‡è§£ç å™¨ç½‘ç»œç”Ÿæˆé‡æ„æ•°æ® $ \mathbf{x}â€™ $ã€‚</li></ul></li><li><p><strong>æŸå¤±è®¡ç®—ä¸ä¼˜åŒ–</strong>ï¼š</p><ul><li>è®¡ç®—é‡æ„æŸå¤±å’ŒKLæ•£åº¦æŸå¤±ï¼Œä¼˜åŒ–æ•´ä¸ªç½‘ç»œä»¥æœ€å°åŒ–æ€»æŸå¤±ã€‚</li></ul></li></ol><h2 id="diffusers-ä»£ç è§£æ"><a class="markdownIt-Anchor" href="#diffusers-ä»£ç è§£æ"></a> Diffusers ä»£ç è§£æ</h2><p>fluxä»£ç ä¸­ä½¿ç”¨çš„vaeæ˜¯å±äºdiffusers.models.autoencoders.autoencoder_kl.AutoencoderKLç±»ï¼Œå› æ­¤æ¥é˜…è¯»å¯¹åº”çš„ä»£ç ,å…·ä½“çš„æ¨¡å‹ä»£ç å°±ä¸ç®¡äº†ï¼Œä¸»è¦å…³æ³¨è¿™ä¸ªä½¿ç”¨çš„æµç¨‹ã€‚</p><p><strong>encodeä»£ç </strong>ï¼šè°ƒç”¨_encode(x)å¾—åˆ°zçš„å‡å€¼å’Œæ–¹å·®é¢„æµ‹h = [mean, logvar]ï¼Œç„¶åä¼ å…¥DiagonalGaussianDistributionç±»å‡†å¤‡å˜é‡é‡‡æ ·ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">encode</span>(<span class="hljs-params"></span><br><span class="hljs-params">    self, x: torch.Tensor, return_dict: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span></span><br><span class="hljs-params"></span>) -&gt; <span class="hljs-type">Union</span>[AutoencoderKLOutput, <span class="hljs-type">Tuple</span>[DiagonalGaussianDistribution]]:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Encode a batch of images into latents.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        x (`torch.Tensor`): Input batch of images.</span><br><span class="hljs-string">        return_dict (`bool`, *optional*, defaults to `True`):</span><br><span class="hljs-string">            Whether to return a [`~models.autoencoder_kl.AutoencoderKLOutput`] instead of a plain tuple.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Returns:</span><br><span class="hljs-string">            The latent representations of the encoded images. If `return_dict` is True, a</span><br><span class="hljs-string">            [`~models.autoencoder_kl.AutoencoderKLOutput`] is returned, otherwise a plain `tuple` is returned.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.use_slicing <span class="hljs-keyword">and</span> x.shape[<span class="hljs-number">0</span>] &gt; <span class="hljs-number">1</span>:<br>        encoded_slices = [<span class="hljs-variable language_">self</span>._encode(x_slice) <span class="hljs-keyword">for</span> x_slice <span class="hljs-keyword">in</span> x.split(<span class="hljs-number">1</span>)]<br>        h = torch.cat(encoded_slices)<br>    <span class="hljs-keyword">else</span>:<br>        h = <span class="hljs-variable language_">self</span>._encode(x)<br><br>    posterior = DiagonalGaussianDistribution(h)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> return_dict:<br>        <span class="hljs-keyword">return</span> (posterior,)<br><br>    <span class="hljs-keyword">return</span> AutoencoderKLOutput(latent_dist=posterior)<br></code></pre></td></tr></table></figure><p><strong>_encodeå‡½æ•°</strong>ï¼šæ¥æ”¶imageä½œä¸ºè¾“å…¥ï¼Œç„¶åè¾“å‡ºåˆšæ‰çš„[mean, logvar]ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_encode</span>(<span class="hljs-params">self, x: torch.Tensor</span>) -&gt; torch.Tensor:<br>    batch_size, num_channels, height, width = x.shape<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.use_tiling <span class="hljs-keyword">and</span> (width &gt; <span class="hljs-variable language_">self</span>.tile_sample_min_size <span class="hljs-keyword">or</span> height &gt; <span class="hljs-variable language_">self</span>.tile_sample_min_size):<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>._tiled_encode(x)<br><br>    enc = <span class="hljs-variable language_">self</span>.encoder(x)<br>    <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.quant_conv <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        enc = <span class="hljs-variable language_">self</span>.quant_conv(enc)<br><br>    <span class="hljs-keyword">return</span> enc<br></code></pre></td></tr></table></figure><p><strong>DiagonalGaussianDistributionç±»ä»£ç </strong>: ä¼ å…¥é¢„æµ‹çš„[mean, logvar]ï¼Œå¯ä»¥è°ƒç”¨sampleé‡‡æ ·å¾—åˆ°é‡å‚æ•°åŒ–çš„zã€‚klå’Œnllåº”è¯¥æ˜¯è®­ç»ƒç”¨çš„lossã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DiagonalGaussianDistribution</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, parameters: torch.Tensor, deterministic: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span></span>):<br>        <span class="hljs-variable language_">self</span>.parameters = parameters<br>        <span class="hljs-variable language_">self</span>.mean, <span class="hljs-variable language_">self</span>.logvar = torch.chunk(parameters, <span class="hljs-number">2</span>, dim=<span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.logvar = torch.clamp(<span class="hljs-variable language_">self</span>.logvar, -<span class="hljs-number">30.0</span>, <span class="hljs-number">20.0</span>)<br>        <span class="hljs-variable language_">self</span>.deterministic = deterministic<br>        <span class="hljs-variable language_">self</span>.std = torch.exp(<span class="hljs-number">0.5</span> * <span class="hljs-variable language_">self</span>.logvar)<br>        <span class="hljs-variable language_">self</span>.var = torch.exp(<span class="hljs-variable language_">self</span>.logvar)<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.deterministic:<br>            <span class="hljs-variable language_">self</span>.var = <span class="hljs-variable language_">self</span>.std = torch.zeros_like(<br>                <span class="hljs-variable language_">self</span>.mean, device=<span class="hljs-variable language_">self</span>.parameters.device, dtype=<span class="hljs-variable language_">self</span>.parameters.dtype<br>            )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">sample</span>(<span class="hljs-params">self, generator: <span class="hljs-type">Optional</span>[torch.Generator] = <span class="hljs-literal">None</span></span>) -&gt; torch.Tensor:<br>        <span class="hljs-comment"># make sure sample is on the same device as the parameters and has same dtype</span><br>        sample = randn_tensor(<br>            <span class="hljs-variable language_">self</span>.mean.shape,<br>            generator=generator,<br>            device=<span class="hljs-variable language_">self</span>.parameters.device,<br>            dtype=<span class="hljs-variable language_">self</span>.parameters.dtype,<br>        )<br>        x = <span class="hljs-variable language_">self</span>.mean + <span class="hljs-variable language_">self</span>.std * sample<br>        <span class="hljs-keyword">return</span> x<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">kl</span>(<span class="hljs-params">self, other: <span class="hljs-string">&quot;DiagonalGaussianDistribution&quot;</span> = <span class="hljs-literal">None</span></span>) -&gt; torch.Tensor:<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.deterministic:<br>            <span class="hljs-keyword">return</span> torch.Tensor([<span class="hljs-number">0.0</span>])<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> other <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">0.5</span> * torch.<span class="hljs-built_in">sum</span>(<br>                    torch.<span class="hljs-built_in">pow</span>(<span class="hljs-variable language_">self</span>.mean, <span class="hljs-number">2</span>) + <span class="hljs-variable language_">self</span>.var - <span class="hljs-number">1.0</span> - <span class="hljs-variable language_">self</span>.logvar,<br>                    dim=[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>],<br>                )<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">0.5</span> * torch.<span class="hljs-built_in">sum</span>(<br>                    torch.<span class="hljs-built_in">pow</span>(<span class="hljs-variable language_">self</span>.mean - other.mean, <span class="hljs-number">2</span>) / other.var<br>                    + <span class="hljs-variable language_">self</span>.var / other.var<br>                    - <span class="hljs-number">1.0</span><br>                    - <span class="hljs-variable language_">self</span>.logvar<br>                    + other.logvar,<br>                    dim=[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>],<br>                )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">nll</span>(<span class="hljs-params">self, sample: torch.Tensor, dims: <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">int</span>, ...] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]</span>) -&gt; torch.Tensor:<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.deterministic:<br>            <span class="hljs-keyword">return</span> torch.Tensor([<span class="hljs-number">0.0</span>])<br>        logtwopi = np.log(<span class="hljs-number">2.0</span> * np.pi)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0.5</span> * torch.<span class="hljs-built_in">sum</span>(<br>            logtwopi + <span class="hljs-variable language_">self</span>.logvar + torch.<span class="hljs-built_in">pow</span>(sample - <span class="hljs-variable language_">self</span>.mean, <span class="hljs-number">2</span>) / <span class="hljs-variable language_">self</span>.var,<br>            dim=dims,<br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">mode</span>(<span class="hljs-params">self</span>) -&gt; torch.Tensor:<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.mean<br><br></code></pre></td></tr></table></figure><p><strong>decode</strong>ï¼šç”¨ä¸Šé¢é‡‡æ ·å¾—åˆ°çš„zé‡å»ºimage xã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@apply_forward_hook</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params"></span><br><span class="hljs-params">        self, z: torch.FloatTensor, return_dict: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>, generator=<span class="hljs-literal">None</span></span><br><span class="hljs-params">    </span>) -&gt; <span class="hljs-type">Union</span>[DecoderOutput, torch.FloatTensor]:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Decode a batch of images.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Args:</span><br><span class="hljs-string">            z (`torch.Tensor`): Input batch of latent vectors.</span><br><span class="hljs-string">            return_dict (`bool`, *optional*, defaults to `True`):</span><br><span class="hljs-string">                Whether to return a [`~models.vae.DecoderOutput`] instead of a plain tuple.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Returns:</span><br><span class="hljs-string">            [`~models.vae.DecoderOutput`] or `tuple`:</span><br><span class="hljs-string">                If return_dict is True, a [`~models.vae.DecoderOutput`] is returned, otherwise a plain `tuple` is</span><br><span class="hljs-string">                returned.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.use_slicing <span class="hljs-keyword">and</span> z.shape[<span class="hljs-number">0</span>] &gt; <span class="hljs-number">1</span>:<br>            decoded_slices = [<span class="hljs-variable language_">self</span>._decode(z_slice).sample <span class="hljs-keyword">for</span> z_slice <span class="hljs-keyword">in</span> z.split(<span class="hljs-number">1</span>)]<br>            decoded = torch.cat(decoded_slices)<br>        <span class="hljs-keyword">else</span>:<br>            decoded = <span class="hljs-variable language_">self</span>._decode(z).sample<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> return_dict:<br>            <span class="hljs-keyword">return</span> (decoded,)<br><br>        <span class="hljs-keyword">return</span> DecoderOutput(sample=decoded)<br></code></pre></td></tr></table></figure><p><strong>_decode</strong>ï¼šç”¨é‡‡æ ·å¾—åˆ°çš„zé‡å»ºimage xçš„å…·ä½“ä»£ç ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_decode</span>(<span class="hljs-params">self, z: torch.Tensor, return_dict: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span></span>) -&gt; <span class="hljs-type">Union</span>[DecoderOutput, torch.Tensor]:<br>    <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.use_tiling <span class="hljs-keyword">and</span> (z.shape[-<span class="hljs-number">1</span>] &gt; <span class="hljs-variable language_">self</span>.tile_latent_min_size <span class="hljs-keyword">or</span> z.shape[-<span class="hljs-number">2</span>] &gt; <span class="hljs-variable language_">self</span>.tile_latent_min_size):<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.tiled_decode(z, return_dict=return_dict)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.post_quant_conv <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        z = <span class="hljs-variable language_">self</span>.post_quant_conv(z)<br><br>    dec = <span class="hljs-variable language_">self</span>.decoder(z)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> return_dict:<br>        <span class="hljs-keyword">return</span> (dec,)<br><br>    <span class="hljs-keyword">return</span> DecoderOutput(sample=dec)<br></code></pre></td></tr></table></figure><p><strong>DecoderOutput</strong>ï¼šå°±æ˜¯ä¸€ä¸ªå­˜æ”¾è¾“å‡ºçš„sampleçš„æ•°æ®ç±»ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DecoderOutput</span>(<span class="hljs-title class_ inherited__">BaseOutput</span>):<br>    <span class="hljs-string">r&quot;&quot;&quot;</span><br><span class="hljs-string">    Output of decoding method.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        sample (`torch.Tensor` of shape `(batch_size, num_channels, height, width)`):</span><br><span class="hljs-string">            The decoded output sample from the last layer of the model.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    sample: torch.Tensor<br>    commit_loss: <span class="hljs-type">Optional</span>[torch.FloatTensor] = <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure><h2 id="1-æ•°æ®ç±»dataclassçš„ä¼˜åŠ¿"><a class="markdownIt-Anchor" href="#1-æ•°æ®ç±»dataclassçš„ä¼˜åŠ¿"></a> 1. æ•°æ®ç±»ï¼ˆ<code>@dataclass</code>ï¼‰çš„ä¼˜åŠ¿</h2><h3 id="11-æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§"><a class="markdownIt-Anchor" href="#11-æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§"></a> 1.1 æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§</h3><p><strong>ç»“æ„åŒ–çš„æ•°æ®è¡¨ç¤º</strong>ï¼š</p><ul><li><p>ä½¿ç”¨ <code>@dataclass</code> å®šä¹‰çš„ç±»æ˜ç¡®åœ°å±•ç¤ºäº†æ•°æ®çš„ç»“æ„å’Œç»„æˆéƒ¨åˆ†ã€‚æ¯ä¸ªå­—æ®µéƒ½æœ‰æ˜ç¡®çš„åç§°å’Œç±»å‹ï¼Œè¿™ä½¿å¾—ä»£ç æ›´åŠ è‡ªè§£é‡Šï¼Œæ˜“äºç†è§£ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DecoderOutput</span>:<br>    sample: torch.Tensor<br>    commit_loss: <span class="hljs-type">Optional</span>[torch.FloatTensor] = <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure><p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œä½¿ç”¨å…ƒç»„æˆ–å­—å…¸æ—¶ï¼Œå­—æ®µçš„æ„ä¹‰å¯èƒ½ä¸é‚£ä¹ˆç›´è§‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ä½¿ç”¨å…ƒç»„</span><br><span class="hljs-keyword">return</span> sample, commit_loss<br><br><span class="hljs-comment"># ä½¿ç”¨å­—å…¸</span><br><span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;sample&quot;</span>: sample, <span class="hljs-string">&quot;commit_loss&quot;</span>: commit_loss&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="12-ç±»å‹æ£€æŸ¥å’Œé™æ€åˆ†ææ”¯æŒ"><a class="markdownIt-Anchor" href="#12-ç±»å‹æ£€æŸ¥å’Œé™æ€åˆ†ææ”¯æŒ"></a> 1.2 ç±»å‹æ£€æŸ¥å’Œé™æ€åˆ†ææ”¯æŒ</h3><p><strong>ç±»å‹æç¤º</strong>ï¼š</p><ul><li><p>æ•°æ®ç±»å…è®¸ä¸ºæ¯ä¸ªå­—æ®µæŒ‡å®šç±»å‹ï¼Œè¿™æœ‰åŠ©äºé™æ€ç±»å‹æ£€æŸ¥å·¥å…·ï¼ˆå¦‚ MyPyï¼‰åœ¨ç¼–è¯‘æ—¶æ•æ‰ç±»å‹é”™è¯¯ï¼Œæå‡ä»£ç çš„å¯é æ€§ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span><br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass<br><br><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DecoderOutput</span>:<br>    sample: torch.Tensor<br>    commit_loss: <span class="hljs-type">Optional</span>[torch.FloatTensor] = <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å…ƒç»„æˆ–å­—å…¸æ—¶ï¼Œç±»å‹ä¿¡æ¯ä¸å¤Ÿæ˜ç¡®ï¼Œå¯èƒ½å¯¼è‡´ç±»å‹é”™è¯¯æ›´éš¾ä»¥æ£€æµ‹ã€‚</p></li></ul><h3 id="13-è‡ªåŠ¨ç”Ÿæˆçš„ç‰¹æ®Šæ–¹æ³•"><a class="markdownIt-Anchor" href="#13-è‡ªåŠ¨ç”Ÿæˆçš„ç‰¹æ®Šæ–¹æ³•"></a> 1.3 è‡ªåŠ¨ç”Ÿæˆçš„ç‰¹æ®Šæ–¹æ³•</h3><p><strong>è‡ªåŠ¨ç”Ÿæˆæ–¹æ³•</strong>ï¼š</p><ul><li><p><code>@dataclass</code> è‡ªåŠ¨ä¸ºç±»ç”Ÿæˆå¸¸ç”¨çš„ç‰¹æ®Šæ–¹æ³•ï¼Œå¦‚ <code>__init__</code>, <code>__repr__</code>, <code>__eq__</code> ç­‰ã€‚è¿™å‡å°‘äº†æ ·æ¿ä»£ç ï¼Œæé«˜äº†å¼€å‘æ•ˆç‡ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DecoderOutput</span>:<br>    sample: torch.Tensor<br>    commit_loss: <span class="hljs-type">Optional</span>[torch.FloatTensor] = <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç è‡ªåŠ¨ç”Ÿæˆäº†ä»¥ä¸‹æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, sample: torch.Tensor, commit_loss: <span class="hljs-type">Optional</span>[torch.FloatTensor] = <span class="hljs-literal">None</span></span>):<br>    <span class="hljs-variable language_">self</span>.sample = sample<br>    <span class="hljs-variable language_">self</span>.commit_loss = commit_loss<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;DecoderOutput(sample=<span class="hljs-subst">&#123;self.sample&#125;</span>, commit_loss=<span class="hljs-subst">&#123;self.commit_loss&#125;</span>)&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, other</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(other, DecoderOutput):<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.sample == other.sample <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.commit_loss == other.commit_loss<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å…ƒç»„æˆ–å­—å…¸ï¼Œéœ€è¦æ‰‹åŠ¨å®ç°è¿™äº›æ–¹æ³•ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œå¢åŠ äº†ä»£ç å¤æ‚æ€§ã€‚</p></li></ul><h3 id="14-æ›´å¥½çš„æ–‡æ¡£å’Œä»£ç æç¤º"><a class="markdownIt-Anchor" href="#14-æ›´å¥½çš„æ–‡æ¡£å’Œä»£ç æç¤º"></a> 1.4 æ›´å¥½çš„æ–‡æ¡£å’Œä»£ç æç¤º</h3><p><strong>æ–‡æ¡£å­—ç¬¦ä¸²å’Œ IDE æ”¯æŒ</strong>ï¼š</p><ul><li><p>æ•°æ®ç±»å¯ä»¥åŒ…å«æ–‡æ¡£å­—ç¬¦ä¸²ï¼ˆdocstringsï¼‰ï¼Œä¸ºç±»å’Œå…¶å­—æ®µæä¾›è¯¦ç»†è¯´æ˜ã€‚è¿™å¯¹å¼€å‘è€…æ¥è¯´éå¸¸æœ‰å¸®åŠ©ï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨ IDE æ—¶ï¼Œèƒ½å¤Ÿæ˜¾ç¤ºè¯¦ç»†çš„æç¤ºä¿¡æ¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DecoderOutput</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Output of decoding method.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        sample (torch.Tensor): The decoded output sample from the last layer of the model.</span><br><span class="hljs-string">        commit_loss (Optional[torch.FloatTensor]): Additional loss for committing to the latent space.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    sample: torch.Tensor<br>    commit_loss: <span class="hljs-type">Optional</span>[torch.FloatTensor] = <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å…ƒç»„æˆ–å­—å…¸æ—¶ï¼Œç¼ºä¹è¿™ç§å†…ç½®çš„æ–‡æ¡£æ”¯æŒï¼Œå¼€å‘è€…éœ€è¦ä¾èµ–å¤–éƒ¨æ–‡æ¡£æˆ–ä»£ç æ³¨é‡Šã€‚</p></li></ul><h3 id="15-é”™è¯¯å‡å°‘å’Œä¸€è‡´æ€§æå‡"><a class="markdownIt-Anchor" href="#15-é”™è¯¯å‡å°‘å’Œä¸€è‡´æ€§æå‡"></a> 1.5 é”™è¯¯å‡å°‘å’Œä¸€è‡´æ€§æå‡</h3><p><strong>é¿å…å­—æ®µé¡ºåºé”™è¯¯</strong>ï¼š</p><ul><li><p>ä½¿ç”¨æ•°æ®ç±»æ—¶ï¼Œå­—æ®µæ˜¯é€šè¿‡åç§°è®¿é—®çš„ï¼Œå‡å°‘äº†ç”±äºå­—æ®µé¡ºåºé”™è¯¯å¯¼è‡´çš„ bugã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œä½¿ç”¨å…ƒç»„æ—¶ï¼Œå¿…é¡»æŒ‰æ­£ç¡®çš„é¡ºåºè®¿é—®å…ƒç´ ï¼Œå®¹æ˜“å‡ºé”™ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">output = DecoderOutput(sample=decoded_sample, commit_loss=loss)<br><span class="hljs-built_in">print</span>(output.sample)<br><span class="hljs-built_in">print</span>(output.commit_loss)<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å…ƒç»„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">output = (decoded_sample, loss)<br><span class="hljs-built_in">print</span>(output[<span class="hljs-number">0</span>])  <span class="hljs-comment"># sample</span><br><span class="hljs-built_in">print</span>(output[<span class="hljs-number">1</span>])  <span class="hljs-comment"># commit_loss</span><br></code></pre></td></tr></table></figure><p>å¦‚æœä¸å°å¿ƒäº¤æ¢äº†é¡ºåºï¼Œå¯èƒ½ä¼šå¯¼è‡´éš¾ä»¥å‘ç°çš„é”™è¯¯ã€‚</p></li></ul><h3 id="16-æ˜“äºæ‰©å±•å’Œä¿®æ”¹"><a class="markdownIt-Anchor" href="#16-æ˜“äºæ‰©å±•å’Œä¿®æ”¹"></a> 1.6 æ˜“äºæ‰©å±•å’Œä¿®æ”¹</h3><p><strong>æ–¹ä¾¿çš„å­—æ®µæ·»åŠ å’Œä¿®æ”¹</strong>ï¼š</p><ul><li><p>å½“éœ€è¦å‘è¾“å‡ºä¸­æ·»åŠ æ–°å­—æ®µæ—¶ï¼Œæ•°æ®ç±»åªéœ€åœ¨ç±»å®šä¹‰ä¸­æ·»åŠ æ–°å­—æ®µï¼Œå…¶ä»–éƒ¨åˆ†ä»£ç æ— éœ€å¤§å¹…ä¿®æ”¹ã€‚ä½¿ç”¨å…ƒç»„æˆ–å­—å…¸æ—¶ï¼Œå¯èƒ½éœ€è¦ä¿®æ”¹å¤šä¸ªä»£ç ä½ç½®æ¥é€‚åº”æ–°å­—æ®µã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DecoderOutput</span>:<br>    sample: torch.Tensor<br>    commit_loss: <span class="hljs-type">Optional</span>[torch.FloatTensor] = <span class="hljs-literal">None</span><br>    additional_info: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">dict</span>] = <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å…ƒç»„æ—¶ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># åŸå…ˆè¿”å›</span><br><span class="hljs-keyword">return</span> sample, commit_loss<br><br><span class="hljs-comment"># ä¿®æ”¹åéœ€è¦è¿”å›æ›´å¤šå…ƒç´ </span><br><span class="hljs-keyword">return</span> sample, commit_loss, additional_info<br></code></pre></td></tr></table></figure><p>è¿™ä¼šå½±å“æ‰€æœ‰è°ƒç”¨è¯¥å‡½æ•°çš„åœ°æ–¹ï¼Œå¢åŠ äº†ç»´æŠ¤æˆæœ¬ã€‚</p></li></ul><h3 id="17-æ›´å¥½çš„é”™è¯¯æ£€æµ‹"><a class="markdownIt-Anchor" href="#17-æ›´å¥½çš„é”™è¯¯æ£€æµ‹"></a> 1.7 æ›´å¥½çš„é”™è¯¯æ£€æµ‹</h3><p><strong>å±æ€§è®¿é—®</strong>ï¼š</p><ul><li><p>ä½¿ç”¨æ•°æ®ç±»æ—¶ï¼Œé€šè¿‡å±æ€§è®¿é—®å­—æ®µï¼Œå¯ä»¥åœ¨ç¼–è¯‘æ—¶æˆ–é™æ€åˆ†ææ—¶æ•æ‰åˆ°ä¸å­˜åœ¨çš„å±æ€§è®¿é—®é”™è¯¯ã€‚è€Œä½¿ç”¨å…ƒç»„æˆ–å­—å…¸æ—¶ï¼Œè¿™ç±»é”™è¯¯å¯èƒ½åªåœ¨è¿è¡Œæ—¶æ‰ä¼šè¢«å‘ç°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># æ•°æ®ç±»</span><br>output = DecoderOutput(sample, commit_loss)<br><span class="hljs-built_in">print</span>(output.sample)        <span class="hljs-comment"># æ­£ç¡®</span><br><span class="hljs-built_in">print</span>(output.non_existent)  <span class="hljs-comment"># AttributeError</span><br><br><span class="hljs-comment"># å…ƒç»„</span><br>output = (sample, commit_loss)<br><span class="hljs-built_in">print</span>(output[<span class="hljs-number">0</span>])            <span class="hljs-comment"># æ­£ç¡®</span><br><span class="hljs-built_in">print</span>(output[<span class="hljs-number">2</span>])            <span class="hljs-comment"># IndexError</span><br><br><span class="hljs-comment"># å­—å…¸</span><br>output = &#123;<span class="hljs-string">&quot;sample&quot;</span>: sample, <span class="hljs-string">&quot;commit_loss&quot;</span>: commit_loss&#125;<br><span class="hljs-built_in">print</span>(output[<span class="hljs-string">&quot;sample&quot;</span>])     <span class="hljs-comment"># æ­£ç¡®</span><br><span class="hljs-built_in">print</span>(output[<span class="hljs-string">&quot;non_existent&quot;</span>])  <span class="hljs-comment"># KeyError</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="18-ç®€åŒ–è°ƒè¯•å’Œæ—¥å¿—è®°å½•"><a class="markdownIt-Anchor" href="#18-ç®€åŒ–è°ƒè¯•å’Œæ—¥å¿—è®°å½•"></a> 1.8 ç®€åŒ–è°ƒè¯•å’Œæ—¥å¿—è®°å½•</h3><p><strong>æ¸…æ™°çš„è¾“å‡º</strong>ï¼š</p><ul><li><p>æ•°æ®ç±»æä¾›äº†æ¸…æ™°çš„ <code>__repr__</code> æ–¹æ³•ï¼Œä½¿å¾—åœ¨è°ƒè¯•å’Œæ—¥å¿—è®°å½•æ—¶ï¼Œè¾“å‡ºä¿¡æ¯æ›´å…·å¯è¯»æ€§å’Œå¯è§£é‡Šæ€§ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DecoderOutput</span>:<br>    sample: torch.Tensor<br>    commit_loss: <span class="hljs-type">Optional</span>[torch.FloatTensor] = <span class="hljs-literal">None</span><br><br>output = DecoderOutput(sample, commit_loss)<br><span class="hljs-built_in">print</span>(output)<br><span class="hljs-comment"># è¾“å‡º: DecoderOutput(sample=tensor([...]), commit_loss=tensor([...]))</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å…ƒç»„æˆ–å­—å…¸æ—¶ï¼Œè¾“å‡ºå¯èƒ½ä¸å¤Ÿç›´è§‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">output = (sample, commit_loss)<br><span class="hljs-built_in">print</span>(output)<br><span class="hljs-comment"># è¾“å‡º: (tensor([...]), tensor([...]))</span><br><br>output = &#123;<span class="hljs-string">&quot;sample&quot;</span>: sample, <span class="hljs-string">&quot;commit_loss&quot;</span>: commit_loss&#125;<br><span class="hljs-built_in">print</span>(output)<br><span class="hljs-comment"># è¾“å‡º: &#123;&#x27;sample&#x27;: tensor([...]), &#x27;commit_loss&#x27;: tensor([...])&#125;</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="19-æ›´å¥½çš„é›†æˆå’Œæ‰©å±•æ€§"><a class="markdownIt-Anchor" href="#19-æ›´å¥½çš„é›†æˆå’Œæ‰©å±•æ€§"></a> 1.9 æ›´å¥½çš„é›†æˆå’Œæ‰©å±•æ€§</h3><p><strong>ä¸å…¶ä»–ç±»å’Œæ–¹æ³•çš„é›†æˆ</strong>ï¼š</p><ul><li><p>æ•°æ®ç±»å¯ä»¥ä½œä¸ºæ›´å¤æ‚æ•°æ®ç»“æ„çš„ä¸€éƒ¨åˆ†ï¼Œä¾¿äºä¸å…¶ä»–ç±»å’Œæ–¹æ³•é›†æˆã€‚ä¾‹å¦‚ï¼Œå¯ä»¥åœ¨æ•°æ®ç±»ä¸­åµŒå¥—å…¶ä»–æ•°æ®ç±»ï¼Œå½¢æˆæ›´å¤æ‚çš„å±‚æ¬¡ç»“æ„ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelOutput</span>:<br>    decoder_output: DecoderOutput<br>    additional_info: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">dict</span>] = <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="110-æ”¯æŒä¸å¯å˜æ€§å¯é€‰"><a class="markdownIt-Anchor" href="#110-æ”¯æŒä¸å¯å˜æ€§å¯é€‰"></a> 1.10 æ”¯æŒä¸å¯å˜æ€§ï¼ˆå¯é€‰ï¼‰</h3><p><strong>ä¸å¯å˜æ•°æ®ç±»</strong>ï¼š</p><ul><li><p>é€šè¿‡è®¾ç½® <code>frozen=True</code>ï¼Œå¯ä»¥åˆ›å»ºä¸å¯å˜çš„æ•°æ®ç±»ï¼Œè¿™åœ¨æŸäº›æƒ…å†µä¸‹æœ‰åŠ©äºé˜²æ­¢æ•°æ®è¢«æ„å¤–ä¿®æ”¹ï¼Œæå‡ä»£ç çš„å®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@dataclass(<span class="hljs-params">frozen=<span class="hljs-literal">True</span></span>)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DecoderOutput</span>:<br>    sample: torch.Tensor<br>    commit_loss: <span class="hljs-type">Optional</span>[torch.FloatTensor] = <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œä¸€æ—¦å®ä¾‹åŒ–ï¼Œå°±æ— æ³•ä¿®æ”¹å…¶å­—æ®µï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">output = DecoderOutput(sample, commit_loss)<br>output.sample = torch.randn(<span class="hljs-number">64</span>, <span class="hljs-number">784</span>)  <span class="hljs-comment"># Raises FrozenInstanceError</span><br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>score based diffusionè§£è¯»</title>
    <link href="/2024/12/28/score-based-diffusion%E8%A7%A3%E8%AF%BB/"/>
    <url>/2024/12/28/score-based-diffusion%E8%A7%A3%E8%AF%BB/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>attention mapå¯è§†åŒ–</title>
    <link href="/2024/12/28/attention-map%E5%8F%AF%E8%A7%86%E5%8C%96/"/>
    <url>/2024/12/28/attention-map%E5%8F%AF%E8%A7%86%E5%8C%96/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ddpmè§£è¯»</title>
    <link href="/2024/12/28/ddpm%E8%A7%A3%E8%AF%BB/"/>
    <url>/2024/12/28/ddpm%E8%A7%A3%E8%AF%BB/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>flow matchingæŠ€æœ¯è§£è¯»</title>
    <link href="/2024/12/28/flow-matching%E6%8A%80%E6%9C%AF%E8%A7%A3%E8%AF%BB/"/>
    <url>/2024/12/28/flow-matching%E6%8A%80%E6%9C%AF%E8%A7%A3%E8%AF%BB/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>fluxä»£ç é˜…è¯»</title>
    <link href="/2024/12/28/flux%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    <url>/2024/12/28/flux%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/</url>
    
    <content type="html"><![CDATA[<h1 id="å¾…å¡«å‘"><a class="markdownIt-Anchor" href="#å¾…å¡«å‘"></a> å¾…å¡«å‘</h1>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å¼ é‡åœ¨å†…å­˜ä¸­çš„å­˜å‚¨(reshape/permuteæ“ä½œç†è§£)</title>
    <link href="/2024/12/28/%E5%BC%A0%E9%87%8F%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84%E5%AD%98%E5%82%A8/"/>
    <url>/2024/12/28/%E5%BC%A0%E9%87%8F%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84%E5%AD%98%E5%82%A8/</url>
    
    <content type="html"><![CDATA[<p>åœ¨é˜…è¯»fluxä»£ç çš„æ—¶å€™ï¼Œçœ‹åˆ°è¿™æ®µå¤„ç†latentçš„ä»£ç æœ‰äº›æ‡µé€¼ï¼Œè¿½æ ¹æº¯æºå°±æ˜¯è‡ªå·±å¯¹äºpytorch Tensoræ•°æ®ç»„ç»‡çš„æ–¹å¼ç†è§£ä¸é€å½»ï¼Œå› æ­¤å†™ä¸‹è¿™ç¯‡åšå®¢å¼€äº‘ç ´é›¾ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@staticmethod</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_pack_latents</span>(<span class="hljs-params">latents, batch_size, num_channels_latents, height, width</span>):<br>    latents = latents.view(batch_size, num_channels_latents, height // <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, width // <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)<br>    latents = latents.permute(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>)<br>    latents = latents.reshape(batch_size, (height // <span class="hljs-number">2</span>) * (width // <span class="hljs-number">2</span>), num_channels_latents * <span class="hljs-number">4</span>)<br><br>    <span class="hljs-keyword">return</span> latents<br></code></pre></td></tr></table></figure><p>åœ¨åº•å±‚å®ç°ä¸­ï¼ŒPyTorch ä¸­çš„å¼ é‡ï¼ˆTensorï¼‰å®é™…ä¸Šæ˜¯ä»¥<strong>ä¸€ç»´çš„è¿ç»­å†…å­˜å—</strong>å­˜å‚¨çš„ï¼Œåªæ˜¯é€šè¿‡<strong>ä¸åŒçš„ stride æ¥æ§åˆ¶æ•°æ®åœ¨å†…å­˜ä¸­çš„è®¿é—®é¡ºåº</strong>ã€‚æˆ‘ä¹ æƒ¯ä»å³å¾€å·¦å»çœ‹å¾…å¼ é‡ï¼Œå› æ­¤æˆ‘è¯´çš„å±‚çš„é¡ºåºæ˜¯ä»å³å¾€å·¦çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pythoh">Example.1ï¼šTensor A.shape: (2, 3, 4)<br>è§†å›¾ï¼š<br>[[[0, 1, 2, 3],   // ç¬¬ä¸€ä¸ª batch, ç¬¬ 1 è¡Œ<br> [4, 5, 6, 7],   // ç¬¬ä¸€ä¸ª batch, ç¬¬ 2 è¡Œ<br> [8, 9, 10, 11]], // ç¬¬ä¸€ä¸ª batch, ç¬¬ 3 è¡Œ<br> [[12, 13, 14, 15],  // ç¬¬äºŒä¸ª batch, ç¬¬ 1 è¡Œ<br> [16, 17, 18, 19],  // ç¬¬äºŒä¸ª batch, ç¬¬ 2 è¡Œ<br> [20, 21, 22, 23]]]  // ç¬¬äºŒä¸ª batch, ç¬¬ 3 è¡Œ<br><br>å†…å­˜ä¸­çš„æ•°æ®ï¼ˆæŒ‰è¡Œä¸»åºæ’åˆ—ï¼‰ï¼š<br>[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]<br></code></pre></td></tr></table></figure><ul><li>stride[2] = 1ï¼ˆæœ€é‡Œå±‚çš„strideéƒ½æ˜¯1ï¼‰ä»£è¡¨æœ€é‡Œå±‚æ¯ä¸ªå…ƒç´ æ˜¯ç´§é‚»çš„ï¼Œä¾‹å¦‚0é©¬ä¸Šå°±æ¥ç€1ç„¶åæ˜¯2ï¼š<br>0,1,2,3,â€¦</li><li>stride[1] = A.shape[2] = 4ï¼Œä»£è¡¨æ¯ç›¸é‚»4ä¸ªå…ƒç´ æ˜¯ä¸€ç»„ ï¼Œä¾‹å¦‚0,1,2,3å››ä¸ªå…ƒç´ æ˜¯ä¸€ç»„ï¼Œæ­¤æ—¶4ï¼Œ5ï¼Œ6ï¼Œ7åˆæ˜¯æ–°çš„ä¸€ç»„:<br>[0,1,2,3], [4,5,6,7], â€¦</li><li>stride[0] = A.shape[2]*A.shape[1] = 3*4ï¼Œä»£è¡¨æ¯ç›¸é‚»12ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªæ›´å¤§çš„ç»„ï¼Œå› æ­¤0-11è¿™12ä¸ªå…ƒç´ ä¼šå½¢æˆæœ€å¤–å±‚çš„å¤§ç»„:<br>[ [0,1,2,3], [4,5,6,7], [8,9,10,11] ], â€¦</li></ul><p>ç”±æ­¤<strong>æ€»ç»“strideçš„è§„å¾‹</strong>ï¼š</p><ul><li>å¯¹äºæœ‰Nä¸ªç»´åº¦çš„Tensor A, $$ stride[i] = \prod_{k=i+1}^{N-1} A.shape[k] \text{ for }  i &lt; N-1 \quad\text{and}\quad stride[N-1]=1$$<br>æˆ‘ä»¬å¯ä»¥æŠŠprintå‡ºæ¥çš„Tensor<strong>ä»ä¸Šåˆ°ä¸‹ï¼Œä»å·¦å¾€å³å±•å¹³æˆä¸€ç»´å‘é‡</strong>ï¼Œ ä»–çš„å¼ é‡è§†å›¾å°±æ˜¯æ ¹æ®ä¸Šè¿°å¾—åˆ°çš„ã€‚</li></ul><p>ç†è§£äº†Tensoræ•°æ®çš„ç»„ç»‡æ–¹æ³•ï¼Œæœ€é‡è¦çš„ä½œç”¨å°±æ˜¯å¯ä»¥<strong>æ¨å¯¼å‡ºreshape(),view()è¿™ä¿©æ“ä½œåæ–°çš„æ•°æ®è§†å›¾</strong>(æ³¨æ„æ²¡æœ‰permute)ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python">Example<span class="hljs-number">.2</span>: å¯¹äº<span class="hljs-number">1</span>ä¸­çš„Tensor A (<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>)ï¼Œå¦‚æœæ‰§è¡ŒA.view(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)ä¼šæ˜¯ä»€ä¹ˆæ ·å­?<br><br>æŒ‰ç…§ä¸Šè¿°åˆ†æï¼Œé¦–å…ˆæŠŠAå±•å¹³æˆä¸€ç»´ï¼š<br>[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,<span class="hljs-number">13</span>,<span class="hljs-number">14</span>,<span class="hljs-number">15</span>,<span class="hljs-number">16</span>,<span class="hljs-number">17</span>,<span class="hljs-number">18</span>,<span class="hljs-number">19</span>,<span class="hljs-number">20</span>,<span class="hljs-number">21</span>,<span class="hljs-number">22</span>,<span class="hljs-number">23</span>]<br><br>å¼•ç”¨strideè§„åˆ™ï¼š<br>stride[<span class="hljs-number">3</span>] = <span class="hljs-number">1</span><br>stride[<span class="hljs-number">2</span>] = <span class="hljs-number">3</span>ï¼Œå¾—åˆ°[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], [<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>],...<br>stride[<span class="hljs-number">1</span>] = <span class="hljs-number">3</span>*<span class="hljs-number">2</span> = <span class="hljs-number">6</span>ï¼Œå¾—åˆ°[[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>],[<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>]], [[<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>],[<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>]],...<br>stride[<span class="hljs-number">0</span>] = <span class="hljs-number">3</span>*<span class="hljs-number">2</span>*<span class="hljs-number">2</span> = <span class="hljs-number">12</span>ï¼Œå¾—åˆ°[[[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>],[<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>]],[[<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>],[<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>]]], [[[<span class="hljs-number">12</span>,<span class="hljs-number">13</span>,<span class="hljs-number">14</span>],[<span class="hljs-number">15</span>,<span class="hljs-number">16</span>,<span class="hljs-number">17</span>]],[[<span class="hljs-number">18</span>,<span class="hljs-number">19</span>,<span class="hljs-number">20</span>],[<span class="hljs-number">21</span>,<span class="hljs-number">22</span>,<span class="hljs-number">23</span>]]]<br><br>äºæ˜¯å˜æ¢åçš„æœ€ç»ˆç»“æœä¸º:<br>[[[[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>],<br>[<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>]],<br>[[<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>],<br>[<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>]]], <br>[[[<span class="hljs-number">12</span>,<span class="hljs-number">13</span>,<span class="hljs-number">14</span>],<br>[<span class="hljs-number">15</span>,<span class="hljs-number">16</span>,<span class="hljs-number">17</span>]],<br>[[<span class="hljs-number">18</span>,<span class="hljs-number">19</span>,<span class="hljs-number">20</span>],<br>[<span class="hljs-number">21</span>,<span class="hljs-number">22</span>,<span class="hljs-number">23</span>]]]]<br><br>åœ¨pytorchä¸­ä»£ç éªŒè¯ï¼Œç»“æœç›¸åŒ:<br><span class="hljs-keyword">import</span> torch<br>    A = torch.arange(<span class="hljs-number">24</span>).reshape(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>)<br>    <span class="hljs-built_in">print</span>(A)<br>    A = A.reshape(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)<br>    <span class="hljs-built_in">print</span>(A)<br>tensor([[[[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>],<br>          [ <span class="hljs-number">3</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>]],<br><br>         [[ <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>,  <span class="hljs-number">8</span>],<br>          [ <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]]],<br><br><br>        [[[<span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>],<br>          [<span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>]],<br><br>         [[<span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>],<br>          [<span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>]]]])    <br></code></pre></td></tr></table></figure><p>ä¸Šè¿°çš„è®¨è®ºå…¶å®å°±æ˜¯view()å’Œreshape()æ“ä½œçš„åŸç†ï¼Œå› æ­¤å¯¹äºåªå«viewå’Œreshapeçš„æ“ä½œï¼Œ<strong>ä¸ç®¡ä¸­é—´ç»´åº¦æ€ä¹ˆå˜æ¢ï¼Œåªè¦è¾“å…¥ç›¸åŒï¼Œä¸”è¾“å‡ºçš„ç»´åº¦ç›¸åŒæœ€åçš„ç»“æœå°±æ˜¯ä¸€æ ·çš„</strong></p><p>å¯¹äº<strong>permute()</strong> æ“ä½œï¼Œä»–çš„åŸç†å’Œå‰ä¸¤ä¸ªä¸åŒï¼Œä¸¾ä¸€ä¸ªä¾‹å­:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python">æœ‰ä¸€ä¸ª<span class="hljs-number">5</span>ç»´Tensor Aï¼ŒA.shape = (<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>)ï¼Œå‡è®¾åŸæ¥Aä¸­çš„å…ƒç´ A[<span class="hljs-number">3</span>][<span class="hljs-number">4</span>][<span class="hljs-number">5</span>][<span class="hljs-number">6</span>][<span class="hljs-number">7</span>] = bï¼Œ<br>è¿›è¡ŒA.permute(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>)åï¼ŒA[<span class="hljs-number">3</span>][<span class="hljs-number">4</span>][<span class="hljs-number">5</span>][<span class="hljs-number">6</span>][<span class="hljs-number">7</span>]ä¼šè¢«æ˜ å°„åˆ°A[<span class="hljs-number">3</span>][<span class="hljs-number">5</span>][<span class="hljs-number">7</span>][<span class="hljs-number">4</span>][<span class="hljs-number">6</span>]ï¼Œ<br>æ‰€ä»¥permuteåA[<span class="hljs-number">3</span>][<span class="hljs-number">5</span>][<span class="hljs-number">7</span>][<span class="hljs-number">4</span>][<span class="hljs-number">6</span>] = bã€‚è¯´åˆ°åº•å°±æ˜¯æ¯ä¸ªå…ƒç´ çš„ç´¢å¼•æŒ‰ç€permuteçš„æ–¹å¼å¯¹åº”å˜æ¢ä½ç½®ã€‚<br><br>æ›´é‡è¦çš„ç†è§£æ–¹å¼å°±æ˜¯strideçš„å˜æ¢ï¼Œå…·ä½“æ¥è¯´åŸå§‹Açš„strideä¹Ÿä¼šæŒ‰ç…§å˜æ¢åˆ°permuteåçš„Açš„strideä¸Šï¼š<br><br><span class="hljs-keyword">import</span> torch<br>x = torch.arange(<span class="hljs-number">24</span>).reshape(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;x çš„æ­¥å¹…:&quot;</span>, x.stride())  <span class="hljs-comment"># è¾“å‡º: (12, 4, 1)</span><br><span class="hljs-built_in">print</span>(x)<br><br>y = x.permute(<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)  <span class="hljs-comment"># æ–°å½¢çŠ¶ä¸º (4, 2, 3)</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Permute åçš„å¼ é‡ y çš„å½¢çŠ¶:&quot;</span>, y.shape)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;y çš„æ­¥å¹…:&quot;</span>, y.stride())  <span class="hljs-comment"># è¾“å‡º: (1, 12, 4)</span><br><span class="hljs-built_in">print</span>(y)<br><br>è¾“å‡ºï¼š<br>x çš„æ­¥å¹…: (<span class="hljs-number">12</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>)<br>tensor([[[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],<br>         [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>],<br>         [ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]],<br><br>        [[<span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>],<br>         [<span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>],<br>         [<span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>]]])<br>Permute åçš„å¼ é‡ y çš„å½¢çŠ¶: torch.Size([<span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])<br>y çš„æ­¥å¹…: (<span class="hljs-number">1</span>, <span class="hljs-number">12</span>, <span class="hljs-number">4</span>)<br>tensor([[[ <span class="hljs-number">0</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">8</span>],<br>         [<span class="hljs-number">12</span>, <span class="hljs-number">16</span>, <span class="hljs-number">20</span>]],<br><br>        [[ <span class="hljs-number">1</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">9</span>],<br>         [<span class="hljs-number">13</span>, <span class="hljs-number">17</span>, <span class="hljs-number">21</span>]],<br><br>        [[ <span class="hljs-number">2</span>,  <span class="hljs-number">6</span>, <span class="hljs-number">10</span>],<br>         [<span class="hljs-number">14</span>, <span class="hljs-number">18</span>, <span class="hljs-number">22</span>]],<br><br>        [[ <span class="hljs-number">3</span>,  <span class="hljs-number">7</span>, <span class="hljs-number">11</span>],<br>         [<span class="hljs-number">15</span>, <span class="hljs-number">19</span>, <span class="hljs-number">23</span>]]])<br><br>è¿›ä¸€æ­¥çš„å¯¹äºä¸Šé¢è¿™ä¸ªä¾‹å­permuteåçš„TensoræŒ‰ç…§æœ€å¼€å§‹è®²çš„ï¼Œå±•å¼€æˆä¸€ç»´ä¸å°±æ˜¯[<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">8</span>,<span class="hljs-number">12</span>,...,<span class="hljs-number">23</span>]å—ï¼Œé‚£æˆ‘èƒ½ä¸èƒ½ç”¨viewæ”¹å˜ä¸€ä¸‹å½¢çŠ¶å‘¢?<br>ä¾‹å¦‚y.view(<span class="hljs-number">2</span>,<span class="hljs-number">12</span>)ä¸å°±è¿”å›[[<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">8</span>,<span class="hljs-number">12</span>,<span class="hljs-number">16</span>,<span class="hljs-number">20</span>,<span class="hljs-number">1</span>,<span class="hljs-number">5</span>,<span class="hljs-number">9</span>,<span class="hljs-number">13</span>,<span class="hljs-number">17</span>,<span class="hljs-number">21</span>], [...]]äº†å—?<br>å®é™…ä¸Šç”±äºy = x.permute()è¿”å›çš„åªæ˜¯åŸæ¥xçš„æ–°è§†å›¾ï¼Œxåœ¨å†…å­˜ä¸­çš„ç‰©ç†å­˜å‚¨æ²¡æœ‰æ”¹å˜è¿˜æ˜¯[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,...]ï¼Œæƒ³è¦æŠŠyå±•å¹³åviewä¼šæŠ¥é”™ï¼š<br><br>Traceback (most recent call last):<br>  File <span class="hljs-string">&quot;/home/ganzhaoxing/RAG-Diffusion/test_reshape.py&quot;</span>, line <span class="hljs-number">10</span>, <span class="hljs-keyword">in</span> &lt;module&gt;<br>    y.view(<span class="hljs-number">2</span>,<span class="hljs-number">12</span>)<br>RuntimeError: view size <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> compatible <span class="hljs-keyword">with</span> <span class="hljs-built_in">input</span> tensors size <span class="hljs-keyword">and</span> stride (at least one dimension spans across two contiguous subspaces). Use .reshape(...) instead.         <br><br>ä»è¿™ä¸ªæŠ¥é”™ä¿¡æ¯å¯ä»¥çŒœæµ‹ï¼Œpytorchå®ç°permuteåº”è¯¥é‡‡ç”¨çš„æ˜¯strideå˜æ¢çš„è§‚ç‚¹ï¼Œä¾‹å¦‚shape = (<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>)çš„strideæœ¬æ¥æ˜¯(<span class="hljs-number">12</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>), <br>permute(<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)åï¼Œç›¸å¯¹äºxçš„ç‰©ç†å­˜å‚¨ï¼Œstrideå˜ä¸º (<span class="hljs-number">1</span>,<span class="hljs-number">12</span>,<span class="hljs-number">4</span>) != (<span class="hljs-number">12</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>)å› æ­¤åˆ¤æ–­ä¸è¿ç»­ã€‚<br><br>è§£å†³æ–¹æ¡ˆï¼šéœ€è¦ç”¨contiguous()å‡½æ•°æŠŠyå¯¹åº”çš„è§†å›¾åœ¨å®é™…ç‰©ç†å­˜å‚¨ä¸Šå˜å¾—è¿ç»­æ‰èƒ½ç”¨viewï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨reshapeå‡½æ•°ä¹Ÿå¯ä»¥(ç›¸å½“äºcontiguous + view)ã€‚<br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å½»åº•ç†è§£äº†Tensoræ•°æ®ç»„ç»‡å’Œå½¢çŠ¶å˜æ¢çš„åŸç†ï¼Œè®©æˆ‘ä»¬é‡æ–°å›åˆ°å¼€å¤´fluxçš„æºç éƒ¨åˆ†è¿›è¡Œè§£è¯»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs python">åŸå§‹è¾“å…¥çš„latents.shape = (batch_size, num_channels_latents, height, width)<br>ç¬¬ä¸€å¥ä»£ç ï¼šlatents = latents.view(batch_size, num_channels_latents, height // <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, width // <span class="hljs-number">2</span>, <span class="hljs-number">2</span>) <br>ä»…ä»…æ”¹å˜äº†æœ€å(height,width)è¿™ä¸¤ä¸ªç»´åº¦ï¼Œä¸ºäº†æ¼”ç¤ºè€ƒè™‘(C,H,W)ç»´åº¦ï¼š<br>original latent = <br>[<span class="hljs-comment">#shape = (2,2,4)</span><br> [[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>],<br>  [<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>]],<br><br> [[<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>],<br>  [<span class="hljs-number">13</span>,<span class="hljs-number">14</span>,<span class="hljs-number">15</span>,<span class="hljs-number">16</span>]]<br>]<br>after view, latent =<br>[<span class="hljs-comment">#shape = (2,1,2,2,2)</span><br>    [<br>     [[[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>],<br>       [<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]],<br><br>      [[<span class="hljs-number">5</span>,<span class="hljs-number">6</span>],<br>       [<span class="hljs-number">7</span>,<span class="hljs-number">8</span>]]]<br>              ],<br><br>    [<br>     [[[<span class="hljs-number">9</span>,<span class="hljs-number">10</span>],<br>       [<span class="hljs-number">11</span>,<span class="hljs-number">12</span>]],<br><br>      [[<span class="hljs-number">13</span>,<span class="hljs-number">14</span>],<br>       [<span class="hljs-number">15</span>,<span class="hljs-number">16</span>]]]<br>               ] <br>]<br><br>ç¬¬äºŒå¥ä»£ç ï¼šlatents = latents.permute(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>)æ‰§è¡ŒåæŠŠlatentså˜æˆ<br>(batch_size, height // <span class="hljs-number">2</span>, width // <span class="hljs-number">2</span>, num_channels_latents, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)ï¼Œä¹‹æ‰€ä»¥è¦è¿™æ ·åšæ˜¯ä¸ºäº†æŠŠï¼Œ<br>ä¸åŒchannelå¯¹åº”çš„åŒä¸€ä¸ª<span class="hljs-number">2</span>*<span class="hljs-number">2</span>çš„åŒºåŸŸæ”¾åœ¨ä¸€èµ·ã€‚<br><br>ç¬¬ä¸‰å¥ä»£ç ï¼šlatents = latents.reshape(batch_size, (height // <span class="hljs-number">2</span>) * (width // <span class="hljs-number">2</span>), num_channels_latents * <span class="hljs-number">4</span>) å°±æ˜¯æœ€åæ•´åˆä¸€ä¸‹ï¼Œåˆå¹¶ä¸€ä¸‹ç»´åº¦ã€‚<br><br>ç”¨ä»£ç å¯è§†åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼Œå¿½ç•¥batchç»´åº¦ï¼š<br><br><span class="hljs-keyword">import</span> torch<br>x = torch.arange(<span class="hljs-number">32</span>).reshape(<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">4</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;x çš„æ­¥å¹…:&quot;</span>, x.stride())  <br><span class="hljs-built_in">print</span>(x)<br>y = x.view(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)  <br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;y çš„æ­¥å¹…:&quot;</span>, y.stride()) <br><span class="hljs-built_in">print</span>(y)<br>y = y.permute(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">4</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;y çš„æ­¥å¹…:&quot;</span>, y.stride())  <br><span class="hljs-built_in">print</span>(y)<br>y = y.reshape(<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">4</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;y çš„æ­¥å¹…:&quot;</span>, y.stride())  <br><span class="hljs-built_in">print</span>(y)<br><br>x çš„æ­¥å¹…: (<span class="hljs-number">16</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>)<br>tensor([[[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],<br>         [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>],<br>         [ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>],<br>         [<span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>]],<br><br>        [[<span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>],<br>         [<span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>],<br>         [<span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">26</span>, <span class="hljs-number">27</span>],<br>         [<span class="hljs-number">28</span>, <span class="hljs-number">29</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>]]])<br>y çš„æ­¥å¹…: (<span class="hljs-number">16</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>)<br>tensor([[[[[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>],<br>           [ <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>]],<br><br>          [[ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>],<br>           [ <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>]]],<br><br><br>         [[[ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>],<br>           [<span class="hljs-number">10</span>, <span class="hljs-number">11</span>]],<br><br>          [[<span class="hljs-number">12</span>, <span class="hljs-number">13</span>],<br>           [<span class="hljs-number">14</span>, <span class="hljs-number">15</span>]]]],<br><br><br><br>        [[[[<span class="hljs-number">16</span>, <span class="hljs-number">17</span>],<br>           [<span class="hljs-number">18</span>, <span class="hljs-number">19</span>]],<br><br>          [[<span class="hljs-number">20</span>, <span class="hljs-number">21</span>],<br>           [<span class="hljs-number">22</span>, <span class="hljs-number">23</span>]]],<br><br><br>         [[[<span class="hljs-number">24</span>, <span class="hljs-number">25</span>],<br>           [<span class="hljs-number">26</span>, <span class="hljs-number">27</span>]],<br><br>          [[<span class="hljs-number">28</span>, <span class="hljs-number">29</span>],<br>           [<span class="hljs-number">30</span>, <span class="hljs-number">31</span>]]]]])<br>y çš„æ­¥å¹…: (<span class="hljs-number">8</span>, <span class="hljs-number">2</span>, <span class="hljs-number">16</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>)<br>tensor([[[[[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>],<br>           [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>]],<br><br>          [[<span class="hljs-number">16</span>, <span class="hljs-number">17</span>],<br>           [<span class="hljs-number">20</span>, <span class="hljs-number">21</span>]]],<br><br><br>         [[[ <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],<br>           [ <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>]],<br><br>          [[<span class="hljs-number">18</span>, <span class="hljs-number">19</span>],<br>           [<span class="hljs-number">22</span>, <span class="hljs-number">23</span>]]]],<br><br><br><br>        [[[[ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>],<br>           [<span class="hljs-number">12</span>, <span class="hljs-number">13</span>]],<br><br>          [[<span class="hljs-number">24</span>, <span class="hljs-number">25</span>],<br>           [<span class="hljs-number">28</span>, <span class="hljs-number">29</span>]]],<br><br><br>         [[[<span class="hljs-number">10</span>, <span class="hljs-number">11</span>],<br>           [<span class="hljs-number">14</span>, <span class="hljs-number">15</span>]],<br><br>          [[<span class="hljs-number">26</span>, <span class="hljs-number">27</span>],<br>           [<span class="hljs-number">30</span>, <span class="hljs-number">31</span>]]]]])<br>y çš„æ­¥å¹…: (<span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>)<br>tensor([[[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>],<br>         [<span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">20</span>, <span class="hljs-number">21</span>]],<br><br>        [[ <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>],<br>         [<span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>]],<br><br>        [[ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>],<br>         [<span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">28</span>, <span class="hljs-number">29</span>]],<br><br>        [[<span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>],<br>         [<span class="hljs-number">26</span>, <span class="hljs-number">27</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>]]])<br><br>æ³¨æ„æ¯ä¸€æ­¥çš„é€»è¾‘ï¼Œæˆ‘ä»¬æ˜¯å…ˆæƒ³æŠŠtensorå˜æ¢æˆåé¢çš„æ ·å­ï¼Œæ ¹æ®è¿™ä¸ªæ ·å­æˆ‘ä»¬èƒ½æ¨å¯¼å‡ºå¯¹åº”çš„strideã€‚<br>äºæ˜¯æ ¹æ®æ–°strideå’Œæ—§strideçš„å˜æ¢å…³ç³»ï¼Œæ¨å¯¼å‡ºpermuteã€viewã€reshapeçš„å…³ç³»ã€‚æ³¨æ„viewå’Œreshapeæ˜¯æŠŠè¾“å…¥å½“åšä»å·¦åˆ°å³ä»ä¸Šåˆ°ä¸‹çš„ä¸€ç»´è¿ç»­å˜é‡è¿›è¡Œå˜æ¢ã€‚         <br></code></pre></td></tr></table></figure><p>ç›¸å…³åšå®¢ï¼š<a href="https://blog.csdn.net/qq_43391414/article/details/120798955">https://blog.csdn.net/qq_43391414/article/details/120798955</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å°è®°</title>
    <link href="/2024/12/27/hello-world/"/>
    <url>/2024/12/27/hello-world/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨å­¦ä¹ çš„æ—¶å€™æ€»æ˜¯ä¼šå®³æ€•è¿‡ä¸€æ®µæ—¶é—´å°±å¿˜è®°ï¼Œäºæ˜¯æœ‰å¾ˆå¼ºçƒˆçš„å»åšä¸ªäººåšå®¢çš„æƒ³æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘å°†åœ¨è¿™ä¸ªåšå®¢è®°å½•ä¸€äº›æ—¥å¸¸å­¦ä¹ çš„å¿ƒå¾—ï¼Œä»¥å…å¾€åé—å¿˜ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
